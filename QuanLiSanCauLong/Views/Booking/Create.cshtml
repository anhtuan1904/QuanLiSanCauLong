@model QuanLiSanCauLong.ViewModels.CreateBookingViewModel

@{
    ViewData["Title"] = "Đặt sân";
}

<div class="container my-4">
    <div class="row">
        <!-- Booking Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-plus"></i> Đặt sân cầu lông</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="bookingForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <input type="hidden" asp-for="CourtId" />
                        <input type="hidden" asp-for="BookingDate" />
                        <input type="hidden" asp-for="StartTime" />
                        <input type="hidden" asp-for="EndTime" />
                        <input type="hidden" asp-for="Duration" />
                        <input type="hidden" asp-for="CourtPrice" />
                        <input type="hidden" asp-for="ServiceFee" />

                        <!-- Booking Info -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">Thông tin đặt sân</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Cơ sở</label>
                                    <div class="fw-bold">@Model.FacilityName</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Sân</label>
                                    <div class="fw-bold">
                                        Sân @Model.CourtNumber
                                        <span class="badge bg-secondary">@Model.CourtType</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Ngày chơi</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-calendar"></i>
                                        @Model.BookingDate.ToString("dd/MM/yyyy")
                                        (@Model.BookingDate.ToString("dddd", new System.Globalization.CultureInfo("vi-VN")))
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Giờ chơi</label>
                                    <div class="fw-bold">
                                        <i class="bi bi-clock"></i>
                                        @Model.StartTime.ToString(@"hh\:mm") - @Model.EndTime.ToString(@"hh\:mm")
                                        <small class="text-muted">(@Model.Duration phút)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">Phương thức thanh toán</h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="PaymentMethod"
                                               id="cash" value="Cash" checked />
                                        <label class="form-check-label" for="cash">
                                            <i class="bi bi-cash"></i> Tiền mặt
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="PaymentMethod"
                                               id="transfer" value="Transfer" />
                                        <label class="form-check-label" for="transfer">
                                            <i class="bi bi-bank"></i> Chuyển khoản
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="PaymentMethod"
                                               id="momo" value="Momo" />
                                        <label class="form-check-label" for="momo">
                                            <i class="bi bi-wallet2"></i> Momo
                                        </label>
                                    </div>
                                </div>l
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="PaymentMethod"
                                               id="zalopay" value="ZaloPay" />
                                        <label class="form-check-label" for="zalopay">
                                            <i class="bi bi-wallet"></i> ZaloPay
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Voucher -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">Mã giảm giá</h6>
                            <div class="input-group">
                                <input type="text" asp-for="VoucherCode" class="form-control"
                                       placeholder="Nhập mã giảm giá (nếu có)" />
                                <button type="button" class="btn btn-outline-success" id="applyVoucher">
                                    <i class="bi bi-check-circle"></i> Áp dụng
                                </button>
                            </div>
                            <span asp-validation-for="VoucherCode" class="text-danger"></span>
                            <div id="voucherMessage" class="mt-2"></div>
                        </div>

                        <!-- Additional Products -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                Sản phẩm đi kèm
                                <small class="text-muted">(Tùy chọn)</small>
                            </h6>

                            <!-- Food -->
                            @if (ViewBag.FoodItems != null && ViewBag.FoodItems.Count > 0)
                            {
                                <div class="mb-3">
                                    <h6 class="text-muted"><i class="bi bi-cup-straw"></i> Đồ ăn</h6>
                                    <div class="row">
                                        @foreach (var item in ViewBag.FoodItems)
                                        {
                                            <div class="col-md-6 mb-2">
                                                <div class="product-item p-2 border rounded">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <div class="fw-bold">@item.ProductName</div>
                                                            <small class="text-success">@item.Price.ToString("N0")đ</small>
                                                        </div>
                                                        <input type="number" name="OrderItems[@item.ProductId].Quantity"
                                                               class="form-control form-control-sm product-quantity"
                                                               style="width: 80px;" min="0" max="99" value="0"
                                                               data-price="@item.Price" data-product-id="@item.ProductId" />
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Beverages -->
                            @if (ViewBag.BeverageItems != null && ViewBag.BeverageItems.Count > 0)
                            {
                                <div class="mb-3">
                                    <h6 class="text-muted"><i class="bi bi-droplet"></i> Nước uống</h6>
                                    <div class="row">
                                        @foreach (var item in ViewBag.BeverageItems)
                                        {
                                            <div class="col-md-6 mb-2">
                                                <div class="product-item p-2 border rounded">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <div class="fw-bold">@item.ProductName</div>
                                                            <small class="text-success">@item.Price.ToString("N0")đ</small>
                                                        </div>
                                                        <input type="number" name="OrderItems[@item.ProductId].Quantity"
                                                               class="form-control form-control-sm product-quantity"
                                                               style="width: 80px;" min="0" max="99" value="0"
                                                               data-price="@item.Price" data-product-id="@item.ProductId" />
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Note -->
                        <div class="mb-4">
                            <label asp-for="Note" class="form-label">Ghi chú</label>
                            <textarea asp-for="Note" class="form-control" rows="3"
                                      placeholder="Nhập ghi chú (nếu có)"></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Xác nhận đặt sân
                            </button>
                            <a asp-action="Search" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Quay lại tìm kiếm
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-receipt"></i> Chi tiết thanh toán</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Giá sân:</span>
                            <strong class="text-success" id="courtPriceDisplay">
                                @Model.CourtPrice.ToString("N0")đ
                            </strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí dịch vụ:</span>
                            <span id="serviceFeeDisplay">@Model.ServiceFee.ToString("N0")đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="productTotalRow" style="display: none !important;">
                            <span>Sản phẩm:</span>
                            <span id="productTotalDisplay">0đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-danger" id="discountRow" style="display: none !important;">
                            <span>Giảm giá:</span>
                            <span id="discountDisplay">0đ</span>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between">
                            <strong>Tổng cộng:</strong>
                            <h5 class="text-success mb-0" id="totalPriceDisplay">
                                @Model.TotalPrice.ToString("N0")đ
                            </h5>
                        </div>
                    </div>

                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Vui lòng có mặt trước giờ chơi 15 phút để check-in
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let courtPrice = @Model.CourtPrice;
        let serviceFee = @Model.ServiceFee;
        let discountAmount = 0;
        let productTotal = 0;

        function updateTotal() {
            const total = courtPrice + serviceFee + productTotal - discountAmount;
            $('#totalPriceDisplay').text(formatCurrency(total));

            if (productTotal > 0) {
                $('#productTotalRow').show();
                $('#productTotalDisplay').text(formatCurrency(productTotal));
            } else {
                $('#productTotalRow').hide();
            }

            if (discountAmount > 0) {
                $('#discountRow').show();
                $('#discountDisplay').text('-' + formatCurrency(discountAmount));
            } else {
                $('#discountRow').hide();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + 'đ';
        }

        $(document).ready(function() {
            // Calculate product total when quantity changes
            $('.product-quantity').on('input', function() {
                productTotal = 0;
                $('.product-quantity').each(function() {
                    const quantity = parseInt($(this).val()) || 0;
                    const price = parseFloat($(this).data('price')) || 0;
                    productTotal += quantity * price;
                });
                updateTotal();
            });

            // Apply voucher
            $('#applyVoucher').on('click', function() {
                const voucherCode = $('#VoucherCode').val().trim();

                if (!voucherCode) {
                    showWarning('Vui lòng nhập mã voucher');
                    return;
                }

                // TODO: Call API to validate voucher
                showInfo('Chức năng đang phát triển');
            });

            // Prevent form resubmit
            $('#bookingForm').on('submit', function() {
                $(this).find('button[type="submit"]').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Đang xử lý...');
            });
        });
    </script>
}