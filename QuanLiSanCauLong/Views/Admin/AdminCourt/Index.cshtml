@model IEnumerable<QuanLiSanCauLong.Models.Court>
@{
    ViewData["Title"] = "Quản Lý Sân";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --deep:#1a1209; --gold:#d4a017; --gold2:#f5c842;
    --cream:#fdf8f0; --warm:#f5ede0; --border:#e8ddd0; --muted:#8a7560;
}
body, * { font-family:'Outfit',sans-serif; }

/* HEADER */
.idx-head { display:flex; align-items:center; justify-content:space-between;
    gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
.idx-title { font-family:'Playfair Display',serif; font-size:1.9rem; font-weight:700; color:var(--deep); }
.idx-title em { font-style:italic; color:var(--gold); }
.add-btn { background:linear-gradient(135deg,var(--gold),var(--gold2)); color:var(--deep);
    border:none; padding:.75rem 1.6rem; font-family:'Outfit',sans-serif; font-size:.86rem; font-weight:700;
    border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:.5rem;
    text-decoration:none; transition:all .25s; }
.add-btn:hover { transform:translateY(-1px); box-shadow:0 6px 18px rgba(212,160,23,.35); color:var(--deep); }

/* STAT STRIP */
.stat-strip { display:grid; grid-template-columns:repeat(4,1fr); gap:1px;
    background:var(--border); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; margin-bottom:1.75rem; }
.stat-box { background:#fff; padding:1.2rem 1.5rem; }
.stat-n { font-family:'Playfair Display',serif; font-size:2rem; font-weight:700;
    color:var(--deep); line-height:1; }
.stat-l { font-size:.72rem; letter-spacing:.08em; text-transform:uppercase; color:var(--muted);
    margin-top:.3rem; display:flex; align-items:center; gap:.4rem; }
.stat-dot { width:7px; height:7px; border-radius:50%; }

/* TOOLBAR */
.toolbar { display:flex; align-items:center; gap:.75rem; margin-bottom:1.25rem; flex-wrap:wrap; }
.tb-search { position:relative; flex:1; min-width:200px; max-width:300px; }
.tb-search input { width:100%; padding:.65rem 1rem .65rem 2.3rem; border:1px solid var(--border);
    border-radius:7px; font-family:'Outfit',sans-serif; font-size:.84rem; color:var(--deep);
    background:#fff; outline:none; transition:border-color .2s; }
.tb-search input:focus { border-color:var(--gold); }
.tb-search i { position:absolute; left:.8rem; top:50%; transform:translateY(-50%); color:var(--muted); }
.tb-sel { padding:.65rem 1rem; border:1px solid var(--border); border-radius:7px;
    font-family:'Outfit',sans-serif; font-size:.84rem; color:var(--deep); background:#fff;
    outline:none; cursor:pointer; }
.tb-sel:focus { border-color:var(--gold); }
.view-btns { display:flex; border:1px solid var(--border); border-radius:7px; overflow:hidden; margin-left:auto; }
.vb { padding:.6rem .9rem; background:#fff; border:none; cursor:pointer;
    font-size:.82rem; color:var(--muted); transition:all .15s; }
.vb.active { background:var(--deep); color:var(--gold2); }
.vb:hover:not(.active) { background:var(--warm); }

/* TABLE */
.idx-table-wrap { background:#fff; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
.idx-table { width:100%; border-collapse:collapse; }
.idx-table th { background:var(--warm); padding:.8rem 1rem; font-size:.67rem; font-weight:700;
    letter-spacing:.12em; text-transform:uppercase; color:var(--muted); text-align:left;
    border-bottom:1px solid var(--border); white-space:nowrap; }
.idx-table td { padding:.9rem 1rem; border-bottom:1px solid var(--border);
    font-size:.86rem; vertical-align:middle; color:var(--deep); }
.idx-table tr:last-child td { border-bottom:none; }
.idx-table tr:hover td { background:var(--cream); }

/* COURT NUMBER BADGE */
.cn-badge { width:38px; height:38px; border-radius:8px; display:flex; align-items:center;
    justify-content:center; font-family:'Playfair Display',serif; font-weight:700;
    font-size:.85rem; color:var(--deep); background:linear-gradient(135deg,var(--gold),var(--gold2));
    flex-shrink:0; }
.court-name-cell { display:flex; align-items:center; gap:.75rem; }
.cn-info .cn-name { font-weight:700; font-size:.88rem; color:var(--deep); line-height:1.2; }
.cn-info .cn-fac  { font-size:.72rem; color:var(--muted); margin-top:.15rem; display:flex; align-items:center; gap:.25rem; }
.cn-info .cn-fac i { color:var(--gold); font-size:.6rem; }

/* STATUS & TYPE CHIPS */
.chip { display:inline-flex; align-items:center; gap:.3rem; font-size:.68rem; font-weight:700;
    padding:.25rem .65rem; border-radius:4px; letter-spacing:.04em; }
.chip-available   { background:rgba(22,163,74,.1);  color:#16a34a; }
.chip-active      { background:rgba(212,160,23,.12); color:#92660a; }
.chip-maintenance { background:rgba(201,75,42,.1);  color:#c94b2a; }
.chip-indoor  { background:rgba(79,70,229,.08); color:#4f46e5; }
.chip-outdoor { background:rgba(234,179,8,.1);  color:#a16207; }
.chip-pvc     { background:rgba(212,160,23,.08); color:#92660a; }
.chip-wood    { background:rgba(120,53,15,.08);  color:#78350f; }
.chip-silicon { background:rgba(6,182,212,.08);  color:#0e7490; }

/* ACTION BUTTONS */
.act-g { display:flex; gap:.3rem; }
.act-b { width:30px; height:30px; border-radius:5px; border:1px solid var(--border);
    background:#fff; display:flex; align-items:center; justify-content:center;
    cursor:pointer; color:var(--muted); transition:all .2s; font-size:.78rem;
    text-decoration:none; }
.act-b:hover.view  { border-color:var(--gold); color:var(--gold); background:rgba(212,160,23,.07); }
.act-b:hover.edit  { border-color:#4f46e5; color:#4f46e5; background:rgba(79,70,229,.07); }
.act-b:hover.del   { border-color:#c94b2a; color:#c94b2a; background:rgba(201,75,42,.07); }

/* CARD VIEW */
.courts-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:1.25rem; }
.cc { background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden;
    transition:all .2s; }
.cc:hover { box-shadow:0 5px 20px rgba(26,18,9,.07); transform:translateY(-1px); }
.cc-img { position:relative; aspect-ratio:16/9; background:var(--warm); }
.cc-img img { width:100%; height:100%; object-fit:cover; }
.cc-img-empty { width:100%; height:100%; display:flex; align-items:center; justify-content:center;
    color:var(--muted); font-size:2rem; opacity:.25; }
.cc-status { position:absolute; top:.7rem; right:.7rem; }
.cc-body { padding:1.1rem 1.25rem; }
.cc-name { font-weight:700; font-size:.95rem; color:var(--deep); margin-bottom:.3rem; }
.cc-facility { font-size:.75rem; color:var(--muted); margin-bottom:.75rem;
    display:flex; align-items:center; gap:.3rem; }
.cc-facility i { color:var(--gold); }
.cc-tags { display:flex; gap:.4rem; flex-wrap:wrap; margin-bottom:.75rem; }
.cc-desc { font-size:.78rem; color:var(--muted); font-weight:300; line-height:1.5;
    overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
.cc-footer { padding:.85rem 1.25rem; border-top:1px solid var(--border); background:var(--warm);
    display:flex; align-items:center; justify-content:space-between; }
.cc-bookings { font-size:.75rem; color:var(--muted); display:flex; align-items:center; gap:.35rem; }

/* SUCCESS/ERROR ALERTS */
.sys-alert { padding:.9rem 1.25rem; border-radius:8px; margin-bottom:1.25rem;
    font-size:.84rem; display:flex; align-items:center; gap:.65rem; }
.sys-alert.success { background:rgba(22,163,74,.08); border:1px solid rgba(22,163,74,.25); color:#16a34a; }
.sys-alert.error   { background:rgba(201,75,42,.06); border:1px solid rgba(201,75,42,.25); color:#c94b2a; }

/* EMPTY STATE */
.empty-state { text-align:center; padding:4rem 2rem; color:var(--muted); }
.empty-state i { font-size:3rem; display:block; margin-bottom:1rem; opacity:.3; }

.hidden { display:none !important; }
</style>

<div>

    <!-- HEADER -->
    <div class="idx-head">
        <div>
            <h1 class="idx-title">Quản Lý <em>Sân Cầu Lông</em></h1>
            <div style="font-size:.82rem;color:var(--muted);margin-top:.25rem;">
                Tổng cộng @(Model?.Count() ?? 0) sân trong hệ thống
            </div>
        </div>
        <a asp-action="Create" class="add-btn">
            <i class="bi bi-plus-circle"></i> Thêm Sân Mới
        </a>
    </div>

    <!-- ALERTS -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="sys-alert success"><i class="bi bi-check-circle-fill"></i>@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="sys-alert error"><i class="bi bi-exclamation-circle"></i>@TempData["ErrorMessage"]</div>
    }

    <!-- STATS -->
    <div class="stat-strip">
        <div class="stat-box">
            <div class="stat-n">@(Model?.Count() ?? 0)</div>
            <div class="stat-l"><span class="stat-dot" style="background:var(--gold);"></span>Tổng Sân</div>
        </div>
        <div class="stat-box">
            <div class="stat-n" style="color:#16a34a;">@(Model?.Count(c => c.Status == "Available") ?? 0)</div>
            <div class="stat-l"><span class="stat-dot" style="background:#16a34a;"></span>Đang Trống</div>
        </div>
        <div class="stat-box">
            <div class="stat-n" style="color:#92660a;">@(Model?.Count(c => c.Status == "Active") ?? 0)</div>
            <div class="stat-l"><span class="stat-dot" style="background:#92660a;"></span>Hoạt Động</div>
        </div>
        <div class="stat-box">
            <div class="stat-n" style="color:#c94b2a;">@(Model?.Count(c => c.Status == "Maintenance") ?? 0)</div>
            <div class="stat-l"><span class="stat-dot" style="background:#c94b2a;"></span>Bảo Trì</div>
        </div>
    </div>

    <!-- TOOLBAR -->
    <form method="get" style="display:contents;">
        <div class="toolbar">
            <div class="tb-search">
                <i class="bi bi-search"></i>
                <input type="text" name="q" placeholder="Tìm tên sân..." id="searchInput" onkeyup="liveSearch()" />
            </div>

            <select name="facilityId" class="tb-sel" onchange="this.form.submit()">
                <option value="">Tất cả cơ sở</option>
                @foreach (var f in (IEnumerable<QuanLiSanCauLong.Models.Facility>)ViewBag.Facilities)
                {
                    <option value="@f.FacilityId"
                            selected="@(ViewBag.SelectedFacility != null && (int)ViewBag.SelectedFacility == f.FacilityId)">
                        @f.FacilityName
                    </option>
                }
            </select>

            <select name="courtType" class="tb-sel" onchange="this.form.submit()">
                <option value="">Vị trí</option>
                <option value="Indoor" selected="@(ViewBag.SelectedType == "Indoor")">Trong nhà</option>
                <option value="Outdoor" selected="@(ViewBag.SelectedType == "Outdoor")">Ngoài trời</option>
            </select>

            <select name="status" class="tb-sel" onchange="this.form.submit()">
                <option value="">Tình trạng</option>
                <option value="Available" selected="@(ViewBag.SelectedStatus == "Available")">Đang trống</option>
                <option value="Active" selected="@(ViewBag.SelectedStatus == "Active")">Hoạt động</option>
                <option value="Maintenance" selected="@(ViewBag.SelectedStatus == "Maintenance")">Bảo trì</option>
            </select>

            <div class="view-btns">
                <button type="button" class="vb" id="vbTable" onclick="switchView('table')" title="Dạng bảng">
                    <i class="bi bi-table"></i>
                </button>
                <button type="button" class="vb active" id="vbCard" onclick="switchView('card')" title="Dạng thẻ">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
        </div>
    </form>
    <!-- ═══════ TABLE VIEW ═══════ -->
    <div id="tableView" class="idx-table-wrap hidden">
        <table class="idx-table">
            <thead>
                <tr>
                    <th>Sân</th>
                    <th>Cơ Sở</th>
                    <th>Vị Trí</th>
                    <th>Mặt Sân</th>
                    <th>Tình Trạng</th>
                    <th>Đặt Sân</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @if (Model?.Any() == true)
                {
                    foreach (var c in Model)
                    {
                        <tr class="court-row"
                            data-name="@c.CourtNumber.ToLower()"
                            data-facility="@(c.Facility?.FacilityName ?? "").ToLower()">
                            <td>
                                <div class="court-name-cell">
                                    <div class="cn-badge">@(c.CourtNumber.Length > 0 ? c.CourtNumber.Substring(c.CourtNumber.Length - Math.Min(2, c.CourtNumber.Length)) : "#")</div>
                                    <div class="cn-info">
                                        <div class="cn-name">@c.CourtNumber</div>
                                        @if (!string.IsNullOrEmpty(c.FloorNumber))
                                        {
                                            <div class="cn-fac"><i class="bi bi-layers-fill"></i>@c.FloorNumber</div>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td style="font-size:.83rem;color:var(--muted);">
                                <i class="bi bi-building" style="color:var(--gold);margin-right:.3rem;"></i>
                                @(c.Facility?.FacilityName ?? "—")
                            </td>
                            <td>
                                <span class="chip chip-@c.CourtType.ToLower()">
                                    @(c.CourtType == "Indoor" ? "🏠 Trong nhà" : "☀️ Ngoài trời")
                                </span>
                            </td>
                            <td>
                                <span class="chip chip-@c.SurfaceType.ToLower()">@c.SurfaceTypeLabel</span>
                            </td>
                            <td>
                                @switch (c.Status)
                                {
                                    case "Available":
                                        <span class="chip chip-available">✓ Đang Trống</span>
                                        break;
                                    case "Active":
                                        <span class="chip chip-active">● Hoạt Động</span>
                                        break;
                                    default:
                                        <span class="chip chip-maintenance">⚠ Bảo Trì</span>
                                        break;
                                }
                            </td>
                            <td style="font-size:.82rem;color:var(--muted);">
                                <i class="bi bi-calendar-check" style="margin-right:.3rem;"></i>
                                @(c.Bookings?.Count() ?? 0)
                            </td>
                            <td>
                                <div class="act-g">
                                    <button class="act-b view" onclick="window.location='/AdminCourt/Details/@c.CourtId'" title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a asp-action="Edit" asp-route-id="@c.CourtId" class="act-b edit" title="Chỉnh sửa">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="act-b del" onclick="confirmDelete(@c.CourtId,'@Html.Raw(c.CourtNumber.Replace("'","&#39;"))')" title="Xóa">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        @if (Model?.Any() != true)
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                Không có sân nào. <a asp-action="Create" style="color:var(--gold);">Thêm ngay</a>
            </div>
        }
    </div>

    <!-- ═══════ CARD VIEW ═══════ -->
    <div id="cardView" class="courts-grid">
        @if (Model?.Any() == true)
        {
            foreach (var c in Model)
            {
                var primaryImg = c.CourtImages?.FirstOrDefault(i => i.IsPrimary) ?? c.CourtImages?.FirstOrDefault();
                var imgSrc     = primaryImg?.ImagePath ?? c.ImagePath;
                <div class="cc court-card-item"
                     data-name="@c.CourtNumber.ToLower()"
                     data-facility="@(c.Facility?.FacilityName ?? "").ToLower()">
                    <div class="cc-img">
                        @if (!string.IsNullOrEmpty(imgSrc))
                        {
                            <img src="@imgSrc" alt="@c.CourtNumber" />
                        }
                        else
                        {
                            <div class="cc-img-empty"><i class="bi bi-image"></i></div>
                        }
                        <div class="cc-status">
                            @switch (c.Status)
                            {
                                case "Available":
                                    <span class="chip chip-available">✓ Đang trống</span>
                                    break;
                                case "Active":
                                    <span class="chip chip-active">● Hoạt động</span>
                                    break;
                                default:
                                    <span class="chip chip-maintenance">⚠ Bảo trì</span>
                                    break;
                            }
                        </div>
                    </div>
                    <div class="cc-body">
                        <div class="cc-name">@c.CourtNumber</div>
                        <div class="cc-facility">
                            <i class="bi bi-building"></i>
                            @(c.Facility?.FacilityName ?? "—")
                            @if (!string.IsNullOrEmpty(c.FloorNumber))
                            {
                                <span style="color:var(--border);">·</span>
                                @c.FloorNumber
                            }
                        </div>
                        <div class="cc-tags">
                            <span class="chip chip-@c.CourtType.ToLower()">
                                @(c.CourtType == "Indoor" ? "🏠 Trong nhà" : "☀️ Ngoài trời")
                            </span>
                            <span class="chip chip-@c.SurfaceType.ToLower()">@c.SurfaceTypeLabel</span>
                            @if (c.HasLighting) { <span class="chip" style="background:rgba(234,179,8,.1);color:#a16207;">💡 Đèn</span> }
                            @if (c.HasAC)       { <span class="chip" style="background:rgba(6,182,212,.08);color:#0e7490;">❄️ AC</span> }
                        </div>
                        @if (!string.IsNullOrEmpty(c.Description))
                        {
                            <div class="cc-desc">@c.Description</div>
                        }
                    </div>
                    <div class="cc-footer">
                        <div class="cc-bookings">
                            <i class="bi bi-calendar-check"></i>
                            @(c.Bookings?.Count() ?? 0) lượt đặt
                        </div>
                        <div class="act-g">
                            <button class="act-b view" onclick="window.location='/AdminCourt/Details/@c.CourtId'" title="Xem">
                                <i class="bi bi-eye"></i>
                            </button>
                            <a asp-action="Edit" asp-route-id="@c.CourtId" class="act-b edit" title="Sửa">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button class="act-b del" onclick="confirmDelete(@c.CourtId,'@Html.Raw(c.CourtNumber.Replace("'","&#39;"))')" title="Xóa">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state" style="grid-column:1/-1;">
                <i class="bi bi-inbox"></i>
                <div>Không tìm thấy sân nào</div>
                <a asp-action="Create" style="color:var(--gold);margin-top:.75rem;display:inline-block;">+ Thêm sân mới</a>
            </div>
        }
    </div>

</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
@Html.AntiForgeryToken()
<script>
// View toggle
let currentView = 'card';
function switchView(v) {
    currentView = v;
    document.getElementById('tableView').classList.toggle('hidden', v !== 'table');
    document.getElementById('cardView').classList.toggle('hidden',  v !== 'card');
    document.getElementById('vbTable').classList.toggle('active', v === 'table');
    document.getElementById('vbCard').classList.toggle('active',  v === 'card');
    localStorage.setItem('courtView', v);
}

// Live search
function liveSearch() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.court-row, .court-card-item').forEach(el => {
        const match = el.dataset.name.includes(q) || el.dataset.facility.includes(q);
        el.style.display = match ? '' : 'none';
    });
}

// Delete
function confirmDelete(id, name) {
    Swal.fire({
        title: `Xóa "${name}"?`,
        text:  'Hình ảnh và dữ liệu sân sẽ bị xóa vĩnh viễn!',
        icon:  'warning',
        showCancelButton: true,
        confirmButtonColor: '#c94b2a',
        cancelButtonColor:  '#8a7560',
        confirmButtonText:  'Xóa',
        cancelButtonText:   'Hủy',
        reverseButtons: true
    }).then(r => {
        if (!r.isConfirmed) return;
        const fd = new FormData();
        fd.append('__RequestVerificationToken',
            document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
        fetch('/AdminCourt/Delete/' + id, { method:'POST', body:fd })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({ icon:'success', title:'Đã xóa!', text:data.message,
                        timer:1500, showConfirmButton:false })
                        .then(() => location.reload());
                } else {
                    Swal.fire('Lỗi!', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Lỗi!', 'Không thể kết nối máy chủ', 'error'));
    });
}

// Restore last view
(function() {
    const saved = localStorage.getItem('courtView') || 'card';
    switchView(saved);
})();
</script>
}
