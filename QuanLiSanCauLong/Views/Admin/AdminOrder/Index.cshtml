@model IEnumerable<QuanLiSanCauLong.ViewModels.OrderViewModel>
@{
    ViewData["Title"] = "Quản lý Đơn Hàng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid px-4 py-4" style="background:#f8f9fa; min-height:100vh;">

    <h4 class="fw-bold mb-4">Quản Lý Đơn Hàng</h4>

    <!-- Stats Cards - giống ảnh 3 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-icon bg-primary-soft mb-3">
                            <i class="bi bi-box-seam text-primary"></i>
                        </div>
                        <div class="fs-2 fw-bold lh-1">@(ViewBag.TotalOrders ?? 0)</div>
                        <div class="text-muted small mt-1">Tổng Đơn Hàng</div>
                    </div>
                    <span class="badge text-success" style="background:#e8f5e9;font-size:.8rem;">+12.5%</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-icon bg-warning-soft mb-3">
                            <i class="bi bi-funnel text-warning"></i>
                        </div>
                        <div class="fs-2 fw-bold lh-1">@(ViewBag.PendingOrders ?? 0)</div>
                        <div class="text-muted small mt-1">Chờ Xử Lý</div>
                    </div>
                    <span class="badge text-warning" style="background:#fff8e1;font-size:.8rem;">+5</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-icon bg-purple-soft mb-3">
                            <i class="bi bi-truck text-purple"></i>
                        </div>
                        <div class="fs-2 fw-bold lh-1">@(ViewBag.ShippingOrders ?? 0)</div>
                        <div class="text-muted small mt-1">Đang Giao</div>
                    </div>
                    <span class="badge text-purple" style="background:#f3e8ff;font-size:.8rem;">+3</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3 h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-icon bg-success-soft mb-3">
                            <i class="bi bi-check-circle text-success"></i>
                        </div>
                        <div class="fs-2 fw-bold lh-1">@(ViewBag.CompletedOrders ?? 0)</div>
                        <div class="text-muted small mt-1">Hoàn Thành</div>
                    </div>
                    <span class="badge text-success" style="background:#e8f5e9;font-size:.8rem;">+28</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Table Card -->
    <div class="card border-0 shadow-sm rounded-3">

        <!-- Card Header -->
        <div class="card-header bg-white border-0 pt-3 pb-0 px-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="fw-bold">Quản Lý Đơn Hàng</div>
                    <div class="text-muted small">Quản lý tất cả đơn hàng và booking</div>
                </div>
                <button class="btn btn-dark rounded-3 fw-semibold px-3" onclick="exportOrders()">
                    <i class="bi bi-download me-1"></i>Xuất Excel
                </button>
            </div>

            <!-- Tabs + Search row -->
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 pb-3">
                <!-- Tabs -->
                <div class="d-flex gap-1 order-tabs">
                    <button class="tab-btn active" data-filter="all">Tất Cả</button>
                    <button class="tab-btn" data-filter="product">Sản Phẩm</button>
                    <button class="tab-btn" data-filter="booking">Đặt Sân</button>
                    <button class="tab-btn" data-filter="package">Gói Tập</button>
                </div>
                <!-- Search + Status filter -->
                <div class="d-flex gap-2">
                    <div class="search-box d-flex align-items-center px-2" style="background:#f5f5f5;border-radius:8px;width:200px;">
                        <i class="bi bi-search text-muted me-1"></i>
                        <input type="text" id="orderSearch" class="border-0 bg-transparent outline-none py-1 w-100"
                               placeholder="Tìm kiếm đơn hàng..." style="outline:none;" oninput="filterOrders()">
                    </div>
                    <select id="statusFilter" class="form-select form-select-sm rounded-3 border-0 bg-light" style="width:120px;" onchange="filterOrders()">
                        <option value="">Tất cả</option>
                        <option value="Pending">Chờ xử lý</option>
                        <option value="Confirmed">Đã xác nhận</option>
                        <option value="Shipping">Đang giao</option>
                        <option value="Completed">Hoàn thành</option>
                        <option value="Cancelled">Đã hủy</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead style="background:#f8f9fa;">
                        <tr>
                            <th class="border-0 py-3 ps-4 text-muted small fw-bold">MÃ ĐƠN</th>
                            <th class="border-0 py-3 text-muted small fw-bold">KHÁCH HÀNG</th>
                            <th class="border-0 py-3 text-muted small fw-bold">SẢN PHẨM/DỊCH VỤ</th>
                            <th class="border-0 py-3 text-muted small fw-bold">TỔNG TIỀN</th>
                            <th class="border-0 py-3 text-muted small fw-bold">NGÀY ĐẶT</th>
                            <th class="border-0 py-3 text-muted small fw-bold">THANH TOÁN</th>
                            <th class="border-0 py-3 text-muted small fw-bold">TRẠNG THÁI</th>
                            <th class="border-0 py-3 pe-4 text-muted small fw-bold text-end">THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var order in Model)
                            {
                                var typeKey = order.OrderType?.ToLower() ?? "product";
                                <tr data-filter="@typeKey" data-status="@order.OrderStatus" data-search="@(order.OrderCode + order.OrderStatus)">

                                    <!-- Mã đơn -->
                                    <td class="ps-4 py-3">
                                        <div class="d-flex align-items-center gap-2">
                                            @if (order.OrderType == "Booking")
                                            {
                                                <span class="type-icon-booking"><i class="bi bi-calendar-check"></i></span>
                                            }
                                            else if (order.OrderType == "Package")
                                            {
                                                <span class="type-icon-package"><i class="bi bi-box2"></i></span>
                                            }
                                            else
                                            {
                                                <span class="type-icon-product"><i class="bi bi-bag"></i></span>
                                            }
                                            <span class="fw-semibold">@order.OrderCode</span>
                                        </div>
                                    </td>

                                    <!-- Khách hàng -->
                                    <td class="py-3">
                                        <div class="fw-semibold small">Khách hàng</div>
                                        <div class="text-muted" style="font-size:.8rem;">0123 456 789</div>
                                    </td>

                                    <!-- Sản phẩm -->
                                    <td class="py-3">
                                        <div class="small text-truncate" style="max-width:180px;">
                                            @string.Join(", ", order.OrderDetails.Take(2).Select(d => d.ProductName))
                                            @(order.OrderDetails.Count > 2 ? "..." : "")
                                        </div>
                                    </td>

                                    <!-- Tổng tiền -->
                                    <td class="py-3">
                                        <span class="fw-bold text-success">₫@order.TotalAmount.ToString("N0")</span>
                                    </td>

                                    <!-- Ngày đặt -->
                                    <td class="py-3">
                                        <div class="small">@order.CreatedAt.ToString("dd/MM/yyyy")</div>
                                        <div class="text-muted" style="font-size:.8rem;">@order.CreatedAt.ToString("HH:mm")</div>
                                    </td>

                                    <!-- Thanh toán -->
                                    <td class="py-3">
                                        @if (order.PaymentStatus == "Paid")
                                        {
                                            <span class="status-badge status-paid">Đã Thanh Toán</span>
                                        }
                                        else if (order.PaymentStatus == "Refunded")
                                        {
                                            <span class="status-badge status-refunded">Đã Hoàn Tiền</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge status-unpaid">Chờ Thanh Toán</span>
                                        }
                                    </td>

                                    <!-- Trạng thái -->
                                    <td class="py-3">
                                        @switch (order.OrderStatus)
                                        {
                                            case "Pending":
                                                <span class="status-badge status-pending">Chờ Xử Lý</span>
                                                break;
                                            case "Confirmed":
                                                <span class="status-badge status-confirmed">Đang Xử Lý</span>
                                                break;
                                            case "Shipping":
                                                <span class="status-badge status-shipping">Đang Giao</span>
                                                break;
                                            case "Completed":
                                                <span class="status-badge status-done">Hoàn Thành</span>
                                                break;
                                            case "Cancelled":
                                                <span class="status-badge status-cancel">Đã Hủy</span>
                                                break;
                                            default:
                                                <span class="status-badge status-pending">@order.OrderStatus</span>
                                                break;
                                        }
                                    </td>

                                    <!-- Thao tác -->
                                    <td class="py-3 pe-4 text-end">
                                        <a asp-action="Details" asp-route-id="@order.OrderId"
                                           class="btn btn-sm btn-outline-secondary rounded-2" title="Chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Không có dữ liệu đơn hàng
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="card-footer bg-white border-0 py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Tổng: @(Model?.Count() ?? 0) đơn</small>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-icon {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
    }

    .bg-primary-soft {
        background: #e8eeff;
    }

    .bg-warning-soft {
        background: #fff8e1;
    }

    .bg-success-soft {
        background: #e8f5e9;
    }

    .bg-purple-soft {
        background: #f3e8ff;
    }

    .text-purple {
        color: #8b5cf6;
    }

    /* Tabs */
    .tab-btn {
        padding: 7px 16px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #fff;
        font-weight: 600;
        font-size: .88rem;
        color: #555;
        cursor: pointer;
        transition: .2s;
    }

        .tab-btn:hover {
            background: #f5f5f5;
        }

        .tab-btn.active {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

    /* Type icons */
    .type-icon-product, .type-icon-booking, .type-icon-package {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: .95rem;
    }

    .type-icon-product {
        background: #e8eeff;
        color: #4361ee;
    }

    .type-icon-booking {
        background: #fff8e1;
        color: #f59e0b;
    }

    .type-icon-package {
        background: #fce7f3;
        color: #ec4899;
    }

    /* Status badges */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: .78rem;
        font-weight: 600;
    }

    .status-paid {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-unpaid {
        background: #fff8e1;
        color: #b45309;
    }

    .status-refunded {
        background: #fce7f3;
        color: #9d174d;
    }

    .status-pending {
        background: #fff8e1;
        color: #b45309;
    }

    .status-confirmed {
        background: #e8eeff;
        color: #3730a3;
    }

    .status-shipping {
        background: #fce7f3;
        color: #7c3aed;
    }

    .status-done {
        background: #e8f5e9;
        color: #166534;
    }

    .status-cancel {
        background: #fee2e2;
        color: #991b1b;
    }

    .table tbody tr {
        cursor: default;
    }

        .table tbody tr:hover {
            background: #fafafa;
        }
</style>

@section Scripts {
    <script>
        // Tab filter
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                filterOrders();
            });
        });

        function filterOrders() {
            const tabFilter = document.querySelector('.tab-btn.active')?.dataset.filter ?? 'all';
            const statusFilter = document.getElementById('statusFilter').value;
            const searchVal = document.getElementById('orderSearch').value.toLowerCase();

            document.querySelectorAll('#orderTableBody tr[data-filter]').forEach(row => {
                const matchTab = tabFilter === 'all' || row.dataset.filter === tabFilter;
                const matchStatus = !statusFilter || row.dataset.status === statusFilter;
                const matchSearch = !searchVal || row.dataset.search.toLowerCase().includes(searchVal) ||
                    row.textContent.toLowerCase().includes(searchVal);
                row.style.display = (matchTab && matchStatus && matchSearch) ? '' : 'none';
            });
        }

        function exportOrders() {
            window.location.href = '/AdminOrder/Export';
        }
    </script>
}
