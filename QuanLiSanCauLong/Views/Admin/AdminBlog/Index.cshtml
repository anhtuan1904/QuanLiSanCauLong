@model IEnumerable<QuanLiSanCauLong.Models.BlogPost>
@{
    ViewData["Title"] = "Quản Lý Bài Viết";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid px-4 py-4" style="background:#f8f9fa; min-height:100vh;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">📝 Quản Lý Bài Viết</h4>
            <p class="text-muted small mb-0">Quản lý tin tức, blog và nội dung website</p>
        </div>
        <button class="btn btn-dark px-4 fw-bold rounded-3" data-bs-toggle="modal" data-bs-target="#modalPost" onclick="openCreateModal()">
            <i class="bi bi-plus-lg me-1"></i> Thêm Bài Viết
        </button>
    </div>

    <!-- Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold text-dark">@Model.Count()</div>
                <div class="text-muted small">Tổng Bài Viết</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold text-success">@Model.Count(p => p.Status == "Published")</div>
                <div class="text-muted small">Đã Xuất Bản</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold text-warning">@Model.Count(p => p.Status == "Draft")</div>
                <div class="text-muted small">Bản Nháp</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold text-primary">@Model.Sum(p => p.ViewCount)</div>
                <div class="text-muted small">Tổng Lượt Xem</div>
            </div>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card border-0 shadow-sm rounded-3 mb-4 p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small text-muted fw-semibold">Tìm kiếm</label>
                <input type="text" name="search" class="form-control" placeholder="Tìm theo tiêu đề..." value="@ViewBag.Search" />
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted fw-semibold">Danh mục</label>
                <select name="categoryId" class="form-select">
                    <option value="">Tất cả danh mục</option>
                    @foreach (var cat in ViewBag.Categories as List<QuanLiSanCauLong.Models.BlogCategory> ?? new())
                    {
                        <option value="@cat.CategoryId">@cat.CategoryName</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted fw-semibold">Trạng thái</label>
                <select name="status" class="form-select">
                    <option value="">Tất cả</option>
                    <option value="Published">Đã xuất bản</option>
                    <option value="Draft">Bản nháp</option>
                    <option value="Archived">Lưu trữ</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Lọc</button>
            </div>
        </form>
    </div>

    <!-- Posts Table -->
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="px-4 py-3" width="5%">#</th>
                            <th class="py-3">Bài Viết</th>
                            <th class="py-3" width="15%">Danh Mục</th>
                            <th class="py-3" width="12%">Trạng Thái</th>
                            <th class="py-3" width="10%">Lượt Xem</th>
                            <th class="py-3" width="12%">Ngày Tạo</th>
                            <th class="py-3 text-center" width="15%">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var post in Model)
                        {
                            var statusClass = post.Status == "Published" ? "success" : (post.Status == "Draft" ? "warning" : "secondary");
                            var statusText = post.Status == "Published" ? "Đã xuất bản" : (post.Status == "Draft" ? "Bản nháp" : "Lưu trữ");

                            <tr>
                                <td class="px-4 align-middle">
                                    @if (post.IsFeatured)
                                    {
                                        <i class="bi bi-star-fill text-warning" title="Nổi bật"></i>
                                    }
                                </td>
                                <td class="align-middle">
                                    <div class="d-flex align-items-center gap-3">
                                        @if (!string.IsNullOrEmpty(post.FeaturedImage))
                                        {
                                            <img src="@post.FeaturedImage" class="rounded" style="width:60px;height:45px;object-fit:cover;" alt="@post.Title" />
                                        }
                                        else
                                        {
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width:60px;height:45px;">
                                                <i class="bi bi-image text-muted"></i>
                                            </div>
                                        }
                                        <div>
                                            <div class="fw-semibold">@post.Title</div>
                                            <small class="text-muted">
                                                @if (!string.IsNullOrEmpty(post.Excerpt))
                                                {
                                                    @(post.Excerpt.Length > 50 ? post.Excerpt.Substring(0, 50) + "..." : post.Excerpt)
                                                }
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td class="align-middle">
                                    <span class="badge bg-light text-dark">@post.Category?.CategoryName</span>
                                </td>
                                <td class="align-middle">
                                    <span class="badge bg-@statusClass">@statusText</span>
                                </td>
                                <td class="align-middle">
                                    <i class="bi bi-eye text-muted me-1"></i>@post.ViewCount.ToString("N0")
                                </td>
                                <td class="align-middle">
                                    <small class="text-muted">@post.CreatedAt.ToString("dd/MM/yyyy")</small>
                                </td>
                                <td class="align-middle text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="openEditModal(@post.PostId)" title="Sửa">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="confirmDelete(@post.PostId, '@post.Title')" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Modal -->
<div class="modal fade" id="modalPost" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4" id="modalPostContent">
            <div class="p-5 text-center">
                <div class="spinner-border text-dark"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-10 rounded-circle" style="width:72px;height:72px;">
                        <i class="bi bi-exclamation-triangle text-danger fs-2"></i>
                    </div>
                </div>
                <h5 class="fw-bold mb-2">Xác nhận xóa?</h5>
                <p class="text-muted small mb-4">Bạn có chắc muốn xóa bài viết <strong id="deleteName" class="text-dark"></strong>?</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-light w-100 rounded-3 fw-semibold py-2" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteForm" method="post" class="w-100">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger w-100 rounded-3 fw-semibold py-2">Xác nhận xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- TinyMCE Self-hosted (Miễn phí vĩnh viễn - không cần API key) -->
    <script src="~/lib/tinymce/tinymce.min.js"></script>

    <script>
        // Fix focus issue trong Bootstrap Modal
        document.addEventListener('focusin', (e) => {
            if (e.target.closest(".tox-tinymce-aux, .moxman-window, .tam-assetmanager-root") !== null) {
                e.stopImmediatePropagation();
            }
        });

        let currentEditor = null;

        function openCreateModal() {
            destroyEditor();
            document.getElementById('modalPostContent').innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-dark"></div><p class="mt-2">Đang tải...</p></div>';

            fetch('/AdminBlog/Create')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('modalPostContent').innerHTML = html;
                    setTimeout(initTinyMCE, 200);
                });
        }

        function openEditModal(id) {
            destroyEditor();
            document.getElementById('modalPostContent').innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-dark"></div><p class="mt-2">Đang tải...</p></div>';
            var modal = new bootstrap.Modal(document.getElementById('modalPost'));
            modal.show();

            fetch('/AdminBlog/Edit/' + id)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('modalPostContent').innerHTML = html;
                    setTimeout(initTinyMCE, 200);
                });
        }

        function destroyEditor() {
            if (currentEditor) {
                currentEditor.remove();
                currentEditor = null;
            }
        }

        function initTinyMCE() {
            const textarea = document.querySelector('#editor-content');
            if (!textarea) {
                console.error('❌ Textarea #editor-content không tìm thấy');
                return;
            }

            tinymce.init({
                selector: '#editor-content',
                height: 500,
                menubar: true,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'media', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | blocks fontsize | ' +
                    'bold italic underline forecolor backcolor | alignleft aligncenter ' +
                    'alignright alignjustify | bullist numlist outdent indent | ' +
                    'removeformat | link image media table | code fullscreen help',

                // ⭐ Quan trọng: chỉ đường dẫn đến thư mục self-hosted
                base_url: '/lib/tinymce',
                suffix: '.min',

                content_style: 'body { font-family: Arial, sans-serif; font-size: 16px; line-height: 1.6; padding: 10px; }',

                // Upload ảnh dưới dạng base64
                images_upload_handler: function (blobInfo, success, failure) {
                    const reader = new FileReader();
                    reader.onload = () => success(reader.result);
                    reader.onerror = () => failure('Upload thất bại');
                    reader.readAsDataURL(blobInfo.blob());
                },

                paste_data_images: true,

                setup: function (editor) {
                    currentEditor = editor;

                    editor.on('init', function () {
                        console.log('✅ TinyMCE Self-hosted khởi tạo thành công!');
                    });

                    // Auto-sync nội dung về textarea
                    editor.on('change input undo redo', function () {
                        editor.save();
                    });
                }
            });
        }

        // Cleanup khi đóng modal
        document.getElementById('modalPost').addEventListener('hidden.bs.modal', function () {
            destroyEditor();
        });

        function confirmDelete(id, title) {
            document.getElementById('deleteName').textContent = title;
            document.getElementById('deleteForm').onsubmit = function (e) {
                e.preventDefault();
                const token = this.querySelector('[name=__RequestVerificationToken]').value;
                fetch('/AdminBlog/Delete/' + id, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: '__RequestVerificationToken=' + encodeURIComponent(token)
                })
                .then(r => r.json())
                .then(res => {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    if (res.success) location.reload();
                    else alert(res.message);
                });
            };
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
    </script>
}
