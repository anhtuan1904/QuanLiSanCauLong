@model QuanLiSanCauLong.ViewModels.InventoryListViewModel

@{
    ViewData["Title"] = "Kho Hàng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Kho Hàng</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item text-muted">Sản Phẩm</li>
                    <li class="breadcrumb-item text-primary fw-bold">Kho Hàng</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-dark btn-sm rounded-3 px-3 shadow-sm" onclick="openInventoryModal('@Url.Action("StockIn")')">
                <i class="bi bi-plus-lg me-2"></i>Nhập Kho
            </button>
            <button type="button" class="btn btn-outline-dark btn-sm rounded-3 px-3 shadow-sm" onclick="openInventoryModal('@Url.Action("StockOut")')">
                <i class="bi bi-box-arrow-up me-2"></i>Xuất Kho
            </button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-soft-primary p-3 rounded-3 text-primary"><i class="bi bi-tag fs-4"></i></div>
                    <div>
                        <h4 class="fw-bold mb-0">@(Model.Items?.Select(i => i.CategoryName).Distinct().Count() ?? 0)</h4>
                        <small class="text-muted">Danh Mục</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-soft-success p-3 rounded-3 text-success"><i class="bi bi-box-seam fs-4"></i></div>
                    <div>
                        <h4 class="fw-bold mb-0">@(Model.Items?.Count ?? 0)</h4>
                        <small class="text-muted">Sản Phẩm</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-soft-info p-3 rounded-3 text-info"><i class="bi bi-warehouse fs-4"></i></div>
                    <div>
                        <h4 class="fw-bold mb-0">@(Model.Items?.Sum(i => i.Quantity) ?? 0)</h4>
                        <small class="text-muted">Tồn Kho</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-soft-danger p-3 rounded-3 text-danger"><i class="bi bi-exclamation-triangle fs-4"></i></div>
                    <div>
                        <h4 class="fw-bold mb-0">@Model.LowStockCount</h4>
                        <small class="text-muted">Cảnh Báo</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-4">
            <div class="mb-4">
                <div class="input-group bg-light rounded-3 p-1" style="max-width: 400px;">
                    <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
                    <input type="text" id="inventorySearch" class="form-control border-0 bg-transparent" placeholder="Tìm kiếm trong kho...">
                </div>
            </div>

            <div class="inventory-container">
                @if (Model.Items != null && Model.Items.Any())
                {
                    @foreach (var item in Model.Items)
                    {
                        <div class="inventory-item-card border rounded-4 p-4 mb-3 transition-all hover-shadow">
                            <div class="row align-items-center g-3">
                                <div class="col-lg-4">
                                    <h5 class="fw-bold mb-1">@item.ProductName</h5>
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="text-muted small">SKU: @item.ProductCode • @item.FacilityName</span>
                                    </div>
                                    @if (item.IsLowStock)
                                    {
                                        <span class="badge bg-danger-subtle text-danger rounded-pill px-3">Cảnh báo tồn thấp</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success-subtle text-success rounded-pill px-3">Tốt</span>
                                    }
                                </div>
                                <div class="col-lg-6">
                                    <div class="row g-2 text-center">
                                        <div class="col-3">
                                            <div class="bg-light p-2 rounded-3">
                                                <h5 class="fw-bold mb-0 @(item.IsLowStock ? "text-danger" : "")">@item.Quantity</h5>
                                                <small class="text-muted small-8">Tổng Kho</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-yellow-subtle p-2 rounded-3">
                                                <h5 class="fw-bold mb-0 text-warning">0</h5>
                                                <small class="text-muted small-8">Đã Đặt</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-info-subtle p-2 rounded-3 text-info">
                                                <h5 class="fw-bold mb-0">@(item.MaxQuantity - item.Quantity < 0 ? 0 : item.MaxQuantity - item.Quantity)</h5>
                                                <small class="text-muted small-8">Có Sẵn</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="bg-danger-subtle p-2 rounded-3 text-danger">
                                                <h5 class="fw-bold mb-0">@(item.Quantity<item.MinQuantity? item.MinQuantity - item.Quantity : 0)</h5>
                                                <small class="text-muted small-8">Mức Nhập</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-2 text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <button onclick="openInventoryModal('@Url.Action("Adjustment", new { inventoryId = item.InventoryId })')" class="btn btn-light btn-sm rounded-circle"><i class="bi bi-pencil"></i></button>
                                        <button onclick="openInventoryModal('@Url.Action("History", new { productId = item.ProductId })')" class="btn btn-light btn-sm rounded-circle"><i class="bi bi-clock-history"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4" id="modalContainer">
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openInventoryModal(url) {
            // Kiểm tra xem Modal có tồn tại không
            const modalElement = document.getElementById('inventoryModal');
            if (!modalElement) {
                console.error("Không tìm thấy ID inventoryModal trong HTML");
                return;
            }

            const modal = new bootstrap.Modal(modalElement);
            $('#modalContainer').html('<div class="p-5 text-center"><div class="spinner-border text-primary"></div></div>');
            modal.show();

            $.get(url)
                .done(function(data) {
                    $('#modalContainer').html(data);
                })
                .fail(function() {
                    $('#modalContainer').html('<div class="p-4 text-center text-danger">Lỗi tải dữ liệu. Vui lòng thử lại.</div>');
                });
        }
    </script>
}

<style>
    .bg-soft-primary {
        background-color: #f0f3ff;
        color: #0d6efd;
    }

    .bg-soft-success {
        background-color: #f0fff4;
        color: #198754;
    }

    .bg-soft-info {
        background-color: #f0faff;
        color: #0dcaf0;
    }

    .bg-soft-danger {
        background-color: #fff5f5;
        color: #dc3545;
    }

    .bg-yellow-subtle {
        background-color: #fffdf0;
    }

    .small-8 {
        font-size: 0.75rem;
    }

    .inventory-item-card {
        transition: all 0.2s;
        border: 1px solid #eee !important;
    }

        .inventory-item-card:hover {
            border-color: #0d6efd !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

    .hover-shadow:hover {
        transform: translateY(-2px);
    }
</style>