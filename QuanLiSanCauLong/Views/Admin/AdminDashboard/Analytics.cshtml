@model QuanLiSanCauLong.ViewModels.AdminDashboardViewModel

@{
    ViewData["Title"] = "Phân tích chi tiết";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1">
                <i class="bi bi-graph-up-arrow text-success me-2"></i>
                Phân tích chi tiết
            </h3>
            <p class="text-muted mb-0 small">Thống kê và báo cáo chi tiết</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
            </button>
            <button class="btn btn-success" onclick="exportDashboard()">
                <i class="bi bi-download me-2"></i>Xuất báo cáo
            </button>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">Từ ngày</label>
                    <input type="date" class="form-control" name="fromDate"
                           value="@Model.FromDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">Đến ngày</label>
                    <input type="date" class="form-control" name="toDate"
                           value="@Model.ToDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="setToday()">
                        Hôm nay
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="setThisWeek()">
                        Tuần này
                    </button>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-search"></i> Áp dụng
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-success-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-cash-stack text-success fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Tổng doanh thu</h6>
                    <h4 class="mb-0 fw-bold text-success">₫@Model.TotalRevenue.ToString("N0")</h4>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-primary-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-calendar-check text-primary fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Booking</h6>
                    <h4 class="mb-0 fw-bold text-primary">₫@Model.BookingRevenue.ToString("N0")</h4>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-info-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-box-seam text-info fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Sản phẩm</h6>
                    <h4 class="mb-0 fw-bold text-info">₫@Model.ProductRevenue.ToString("N0")</h4>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-warning-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-graph-up text-warning fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Đơn đặt sân</h6>
                    <h4 class="mb-0 fw-bold text-warning">@Model.TotalBookings</h4>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-danger-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-people text-danger fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Khách hàng</h6>
                    <h4 class="mb-0 fw-bold text-danger">@Model.TotalCustomers</h4>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 col-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center py-3">
                    <div class="icon-box-small bg-secondary-subtle rounded-3 p-2 d-inline-flex mb-2">
                        <i class="bi bi-cart3 text-secondary fs-5"></i>
                    </div>
                    <h6 class="text-muted mb-1 small">Đơn hàng</h6>
                    <h4 class="mb-0 fw-bold text-secondary">@Model.TotalOrders</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts -->
    <div class="row g-4 mb-4">
        <!-- Revenue Trend -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-graph-up text-success me-2"></i>
                                Xu hướng doanh thu
                            </h5>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success active">Ngày</button>
                            <button type="button" class="btn btn-outline-success">Tuần</button>
                            <button type="button" class="btn btn-outline-success">Tháng</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Revenue Breakdown Pie -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-pie-chart text-primary me-2"></i>
                        Cơ cấu doanh thu
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueBreakdownChart" height="300"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Booking</span>
                            <strong class="text-success small">
                                @((Model.BookingRevenue / Model.TotalRevenue * 100).ToString("F1"))%
                            </strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="small">Sản phẩm</span>
                            <strong class="text-info small">
                                @((Model.ProductRevenue / Model.TotalRevenue * 100).ToString("F1"))%
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Facility Performance -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-building text-warning me-2"></i>
                        Hiệu suất cơ sở
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="facilityPerformanceChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Grid -->
    <div class="row g-4 mb-4">
        <!-- Top Products -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-trophy text-warning me-2"></i>
                        Sản phẩm bán chạy
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 py-3">#</th>
                                    <th class="border-0 py-3">Sản phẩm</th>
                                    <th class="border-0 py-3 text-center">Số lượng</th>
                                    <th class="border-0 py-3 text-end">Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.TopProducts != null && Model.TopProducts.Any())
                                {
                                    var rank = 1;
                                    foreach (var product in Model.TopProducts.Take(10))
                                    {
                                        <tr>
                                            <td class="py-3">
                                                @if (rank <= 3)
                                                {
                                                    <span class="badge bg-warning rounded-circle" style="width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center;">@rank</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@rank</span>
                                                }
                                            </td>
                                            <td class="py-3">
                                                <div class="fw-semibold">@product.ProductName</div>
                                                <small class="text-muted">@product.CategoryType</small>
                                            </td>
                                            <td class="py-3 text-center">
                                                <span class="badge bg-info-subtle text-info">@product.QuantitySold</span>
                                            </td>
                                            <td class="py-3 text-end text-success fw-semibold">
                                                ₫@product.Revenue.ToString("N0")
                                            </td>
                                        </tr>
                                        rank++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Time Slots -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-clock text-info me-2"></i>
                        Khung giờ phổ biến
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 py-3">Khung giờ</th>
                                    <th class="border-0 py-3 text-center">Đặt sân</th>
                                    <th class="border-0 py-3 text-end">Doanh thu</th>
                                    <th class="border-0 py-3" style="width: 100px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.PopularTimeSlots != null && Model.PopularTimeSlots.Any())
                                {
                                    var maxBooking = Model.PopularTimeSlots.Max(s => s.BookingCount);
                                    foreach (var slot in Model.PopularTimeSlots.Take(10))
                                    {
                                        var percentage = (slot.BookingCount * 100.0 / maxBooking);
                                        <tr>
                                            <td class="py-3"><strong>@slot.TimeSlot</strong></td>
                                            <td class="py-3 text-center">
                                                <span class="badge bg-primary-subtle text-primary">@slot.BookingCount</span>
                                            </td>
                                            <td class="py-3 text-end text-success fw-semibold">
                                                ₫@slot.Revenue.ToString("N0")
                                            </td>
                                            <td class="py-3">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-primary"
                                                         style="width: @percentage%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Customers -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-star text-danger me-2"></i>
                        Khách hàng VIP (Top 15)
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 py-3">#</th>
                                    <th class="border-0 py-3">Khách hàng</th>
                                    <th class="border-0 py-3">Email</th>
                                    <th class="border-0 py-3">Điện thoại</th>
                                    <th class="border-0 py-3 text-center">Số lượt</th>
                                    <th class="border-0 py-3 text-end">Tổng chi</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.TopCustomers != null && Model.TopCustomers.Any())
                                {
                                    var rank = 1;
                                    foreach (var customer in Model.TopCustomers.Take(15))
                                    {
                                        <tr>
                                            <td class="py-3">
                                                @if (rank == 1)
                                                {
                                                    <i class="bi bi-trophy-fill text-warning fs-5"></i>
                                                }
                                                else if (rank == 2)
                                                {
                                                    <i class="bi bi-trophy-fill text-secondary fs-5"></i>
                                                }
                                                else if (rank == 3)
                                                {
                                                    <i class="bi bi-trophy-fill text-danger fs-5"></i>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">@rank</span>
                                                }
                                            </td>
                                            <td class="py-3">
                                                <div class="d-flex align-items-center">
                                                    <div class="icon-box-small bg-success-subtle rounded-circle p-2 me-2">
                                                        <i class="bi bi-person text-success"></i>
                                                    </div>
                                                    <strong>@customer.CustomerName</strong>
                                                </div>
                                            </td>
                                            <td class="py-3 text-muted">@customer.Email</td>
                                            <td class="py-3 text-muted">@customer.Phone</td>
                                            <td class="py-3 text-center">
                                                <span class="badge bg-info-subtle text-info">@customer.BookingCount</span>
                                            </td>
                                            <td class="py-3 text-end fw-bold text-success">
                                                ₫@customer.TotalSpent.ToString("N0")
                                            </td>
                                        </tr>
                                        rank++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Date Filter Functions
        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="fromDate"]').value = today;
            document.querySelector('[name="toDate"]').value = today;
        }

        function setThisWeek() {
            const today = new Date();
            const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
            const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));

            document.querySelector('[name="fromDate"]').value = firstDay.toISOString().split('T')[0];
            document.querySelector('[name="toDate"]').value = lastDay.toISOString().split('T')[0];
        }

        function refreshData() {
            location.reload();
        }

        function exportDashboard() {
            window.print();
        }

        // Revenue Trend Chart
        const revenueTrendCtx = document.getElementById('revenueTrendChart').getContext('2d');
        new Chart(revenueTrendCtx, {
            type: 'line',
            data: {
                labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8'],
                datasets: [{
                    label: 'Doanh Thu',
                    data: [2800000, 3200000, 2900000, 3500000, 3800000, 3300000, 4200000, 4000000],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Revenue Breakdown Chart
        const breakdownCtx = document.getElementById('revenueBreakdownChart').getContext('2d');
        new Chart(breakdownCtx, {
            type: 'doughnut',
            data: {
                labels: ['Vợt', 'Giày', 'Phụ Kiện', 'Quần Áo'],
                datasets: [{
                    data: [35, 28, 15, 22],
                    backgroundColor: ['#10b981', '#6366f1', '#f59e0b', '#ec4899'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, usePointStyle: true }
                    }
                }
            }
        });

        // Facility Performance Chart
        const facilityCtx = document.getElementById('facilityPerformanceChart').getContext('2d');
        new Chart(facilityCtx, {
            type: 'bar',
            data: {
                labels: ['Cơ sở 1', 'Cơ sở 2', 'Cơ sở 3', 'Cơ sở 4', 'Cơ sở 5', 'Cơ sở 6'],
                datasets: [{
                    label: 'Doanh Thu',
                    data: [4500000, 3800000, 4200000, 3900000, 4100000, 3700000],
                    backgroundColor: '#10b981',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    </script>
}

<style>
    .icon-box-small {
        width: 48px;
        height: 48px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .bg-success-subtle {
        background-color: rgba(16, 185, 129, 0.1) !important;
    }

    .bg-primary-subtle {
        background-color: rgba(99, 102, 241, 0.1) !important;
    }

    .bg-info-subtle {
        background-color: rgba(14, 165, 233, 0.1) !important;
    }

    .bg-warning-subtle {
        background-color: rgba(245, 158, 11, 0.1) !important;
    }

    .bg-danger-subtle {
        background-color: rgba(239, 68, 68, 0.1) !important;
    }

    .bg-secondary-subtle {
        background-color: rgba(107, 114, 128, 0.1) !important;
    }

    .bg-pink-subtle {
        background-color: rgba(236, 72, 153, 0.1) !important;
    }

    .text-pink {
        color: #ec4899 !important;
    }

    .card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
        }
</style>
