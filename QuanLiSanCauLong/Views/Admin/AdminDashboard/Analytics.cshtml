@model QuanLiSanCauLong.ViewModels.AdminDashboardViewModel

@{
    ViewData["Title"] = "Phân tích chi tiết";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">
        <i class="bi bi-graph-up-arrow text-primary me-2"></i>
        Phân tích chi tiết
    </h2>
    <div class="btn-group">
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise me-2"></i>Làm mới
        </button>
        <button class="btn btn-success" onclick="exportDashboard()">
            <i class="bi bi-download me-2"></i>Xuất báo cáo
        </button>
    </div>
</div>

<!-- Date Range -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-semibold">Từ ngày</label>
                <input type="date" class="form-control" name="fromDate"
                       value="@Model.FromDate.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Đến ngày</label>
                <input type="date" class="form-control" name="toDate"
                       value="@Model.ToDate.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="setToday()">
                    Hôm nay
                </button>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="setThisWeek()">
                    Tuần này
                </button>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Áp dụng
                </button>
            </div>
        </form>
    </div>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-primary bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-cash-stack text-primary fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Tổng doanh thu</h6>
                <h4 class="mb-0 fw-bold text-primary">@Model.TotalRevenue.ToString("N0")đ</h4>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-success bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-calendar-check text-success fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Booking</h6>
                <h4 class="mb-0 fw-bold text-success">@Model.BookingRevenue.ToString("N0")đ</h4>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-info bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-box-seam text-info fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Sản phẩm</h6>
                <h4 class="mb-0 fw-bold text-info">@Model.ProductRevenue.ToString("N0")đ</h4>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-warning bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-graph-up text-warning fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Đơn đặt sân</h6>
                <h4 class="mb-0 fw-bold text-warning">@Model.TotalBookings</h4>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-danger bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-people text-danger fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Khách hàng</h6>
                <h4 class="mb-0 fw-bold text-danger">@Model.TotalCustomers</h4>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-md-4 col-sm-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="bg-secondary bg-opacity-10 rounded-circle p-3 d-inline-block mb-2">
                    <i class="bi bi-cart3 text-secondary fs-3"></i>
                </div>
                <h6 class="text-muted mb-1">Đơn hàng</h6>
                <h4 class="mb-0 fw-bold text-secondary">@Model.TotalOrders</h4>
            </div>
        </div>
    </div>
</div>

<!-- Main Charts -->
<div class="row g-4 mb-4">
    <!-- Revenue Trend -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-graph-up text-primary me-2"></i>
                        Xu hướng doanh thu
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-type="day">Ngày</button>
                        <button type="button" class="btn btn-outline-primary" data-type="week">Tuần</button>
                        <button type="button" class="btn btn-outline-primary" data-type="month">Tháng</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="revenueTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Revenue Breakdown -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-pie-chart text-success me-2"></i>
                    Cơ cấu doanh thu
                </h5>
            </div>
            <div class="card-body">
                <canvas id="revenueBreakdownChart" height="300"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Booking</span>
                        <strong class="text-success">
                            @((Model.BookingRevenue / Model.TotalRevenue * 100).ToString("F1"))%
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Sản phẩm</span>
                        <strong class="text-info">
                            @((Model.ProductRevenue / Model.TotalRevenue * 100).ToString("F1"))%
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Facility Performance -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-building text-warning me-2"></i>
                    Hiệu suất cơ sở
                </h5>
            </div>
            <div class="card-body">
                <canvas id="facilityPerformanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Details Grid -->
<div class="row g-4 mb-4">
    <!-- Top Products -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-trophy text-warning me-2"></i>
                    Sản phẩm bán chạy
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Sản phẩm</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-end">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.TopProducts != null && Model.TopProducts.Any())
                            {
                                var rank = 1;
                                foreach (var product in Model.TopProducts.Take(10))
                                {
                                    <tr>
                                        <td>
                                            @if (rank <= 3)
                                            {
                                                <span class="badge bg-warning">@rank</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">@rank</span>
                                            }
                                        </td>
                                        <td>
                                            <strong>@product.ProductName</strong>
                                            <br>
                                            <small class="text-muted">@product.CategoryType</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@product.QuantitySold</span>
                                        </td>
                                        <td class="text-end text-success fw-semibold">
                                            @product.Revenue.ToString("N0")đ
                                        </td>
                                    </tr>
                                    rank++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Time Slots -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-clock text-info me-2"></i>
                    Khung giờ phổ biến
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Khung giờ</th>
                                <th class="text-center">Đặt sân</th>
                                <th class="text-end">Doanh thu</th>
                                <th style="width: 100px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.PopularTimeSlots != null && Model.PopularTimeSlots.Any())
                            {
                                var maxBooking = Model.PopularTimeSlots.Max(s => s.BookingCount);
                                foreach (var slot in Model.PopularTimeSlots.Take(10))
                                {
                                    var percentage = (slot.BookingCount * 100.0 / maxBooking);
                                    <tr>
                                        <td><strong>@slot.TimeSlot</strong></td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">@slot.BookingCount</span>
                                        </td>
                                        <td class="text-end text-success fw-semibold">
                                            @slot.Revenue.ToString("N0")đ
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-primary"
                                                     style="width: @percentage%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Top Customers -->
<div class="row g-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 border-bottom">
                <h5 class="mb-0 fw-bold">
                    <i class="bi bi-star text-danger me-2"></i>
                    Khách hàng VIP (Top 15)
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Khách hàng</th>
                                <th>Email</th>
                                <th>Điện thoại</th>
                                <th class="text-center">Số lượt</th>
                                <th class="text-end">Tổng chi</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.TopCustomers != null && Model.TopCustomers.Any())
                            {
                                var rank = 1;
                                foreach (var customer in Model.TopCustomers.Take(15))
                                {
                                    <tr>
                                        <td>
                                            @if (rank == 1)
                                            {
                                                <i class="bi bi-trophy-fill text-warning fs-5"></i>
                                            }
                                            else if (rank == 2)
                                            {
                                                <i class="bi bi-trophy-fill text-secondary fs-5"></i>
                                            }
                                            else if (rank == 3)
                                            {
                                                <i class="bi bi-trophy-fill text-danger fs-5"></i>
                                            }
                                            else
                                            {
                                                <span class="text-muted">@rank</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                                    <i class="bi bi-person text-primary"></i>
                                                </div>
                                                <strong>@customer.CustomerName</strong>
                                            </div>
                                        </td>
                                        <td>@customer.Email</td>
                                        <td>@customer.Phone</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@customer.BookingCount</span>
                                        </td>
                                        <td class="text-end fw-bold text-success">
                                            @customer.TotalSpent.ToString("N0")đ
                                        </td>
                                    </tr>
                                    rank++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart implementations here
        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('[name="fromDate"]').value = today;
            document.querySelector('[name="toDate"]').value = today;
        }

        function setThisWeek() {
            const today = new Date();
            const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
            const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));

            document.querySelector('[name="fromDate"]').value = firstDay.toISOString().split('T')[0];
            document.querySelector('[name="toDate"]').value = lastDay.toISOString().split('T')[0];
        }

        function refreshData() {
            location.reload();
        }

        function exportDashboard() {
            window.print();
        }
    </script>
}