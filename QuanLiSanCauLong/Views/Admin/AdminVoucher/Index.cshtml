@model IEnumerable<QuanLiSanCauLong.ViewModels.VoucherViewModel>

@{
    ViewData["Title"] = "Quản lý Voucher";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var currentTime = DateTime.Now;
}

<div class="container-fluid py-4">
    <div class="row g-3 mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold mb-1">Voucher & Khuyến Mãi</h2>
            <p class="text-muted small">Tạo và quản lý các chiến dịch giảm giá cho hệ thống</p>
        </div>
        <div class="col-md-4 text-md-end">
            <button type="button" class="btn btn-dark rounded-3 px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#createVoucherModal">
                <i class="bi bi-plus-lg me-2"></i>Tạo Voucher Mới
            </button>
        </div>
    </div>

    @* --- Dashboard Stats --- *@
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center">
                    <div class="bg-soft-primary p-3 rounded-3 me-3">
                        <i class="bi bi-ticket-perforated text-primary fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Tổng Voucher</div>
                        <div class="fw-bold fs-5">@ViewBag.TotalVouchers</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center">
                    <div class="bg-soft-success p-3 rounded-3 me-3">
                        <i class="bi bi-lightning-charge text-success fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Đang Hoạt Động</div>
                        <div class="fw-bold fs-5">@ViewBag.ActiveVouchers</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center">
                    <div class="bg-soft-info p-3 rounded-3 me-3">
                        <i class="bi bi-person-check text-info fs-4"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Đã Sử Dụng</div>
                        <div class="fw-bold fs-5">@ViewBag.TotalUsage</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <form method="get" id="filterForm">
                    <div class="text-muted small mb-1">Bộ lọc nhanh</div>
                    <select name="status" class="form-select form-select-sm border-0 bg-light" onchange="this.form.submit()">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="upcoming">Sắp diễn ra</option>
                        <option value="expired">Đã hết hạn</option>
                        <option value="inactive">Đã tạm dừng</option>
                    </select>
                </form>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success border-0 shadow-sm rounded-3 mb-4">
            <i class="bi bi-check-circle me-2"></i> @TempData["SuccessMessage"]
        </div>
    }

    @* --- Danh sách Voucher --- *@
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            @if (Model != null && Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var voucher in Model)
                    {
                        <div class="list-group-item p-4 border-bottom hover-bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light p-3 rounded-4 me-3 text-center" style="min-width: 70px;">
                                            <i class="bi @(voucher.DiscountType == "Percentage" ? "bi-percent" : "bi-cash-stack") text-dark fs-3"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-1">@voucher.VoucherName</h6>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-soft-dark text-dark border fw-bold px-2">@voucher.VoucherCode</span>
                                                @if (!voucher.IsActive)
                                                {
                                                    <span class="badge bg-soft-secondary text-secondary rounded-pill small">Tạm dừng</span>
                                                }
                                                else if (voucher.StartDate > currentTime)
                                                {
                                                    <span class="badge bg-soft-info text-info rounded-pill small">Sắp diễn ra</span>
                                                }
                                                else if (voucher.EndDate < currentTime)
                                                {
                                                    <span class="badge bg-soft-danger text-danger rounded-pill small">Hết hạn</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-soft-success text-success rounded-pill small">Đang chạy</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @* SỬA LỖI ĐỊNH DẠNG SỐ TẠI ĐÂY *@
                                <div class="col-md-3 text-center border-start border-end">
                                    <div class="fs-4 fw-bold text-success">
                                        @if (voucher.DiscountType == "Percentage")
                                        {
                                            @($"{voucher.DiscountValue:0.#}%")
                                        }
                                        else
                                        {
                                            @voucher.DiscountValue.ToString("N0")
                                
                                            @:đ
                                        }
                                    </div>
                                    <div class="text-muted small">
                                        @* Cả MaxDiscount và MinOrderAmount đều cần kiểm tra .HasValue *@
                                        Tối đa: @(voucher.MaxDiscount.HasValue? voucher.MaxDiscount.Value.ToString("N0") : "∞") |
                                        Min: @(voucher.MinOrderAmount.HasValue? voucher.MinOrderAmount.Value.ToString("N0") : "0")đ
                                    </div>
                                </div>

                                <div class="col-md-3 px-4">
                                    <div class="d-flex justify-content-between mb-1 small">
                                        <span>Sử dụng</span>
                                        <span class="fw-bold">@voucher.UsedCount / @(voucher.UsageLimit.HasValue? voucher.UsageLimit.Value.ToString() : "∞")</span>
                                    </div>
                                    <div class="progress rounded-pill" style="height: 6px;">
                                        @{
                                            double percent = 0;
                                            if (voucher.UsageLimit.HasValue && voucher.UsageLimit > 0)
                                            {
                                                percent = (double)voucher.UsedCount * 100.0 / (double)voucher.UsageLimit.Value;
                                            }
                                        }
                                        <div class="progress-bar @(percent >= 90 ? "bg-danger" : (percent >= 50 ? "bg-warning" : "bg-success"))"
                                             role="progressbar" style="width: @percent%"></div>
                                    </div>
                                    <div class="text-muted extra-small mt-1 text-end" style="font-size: 0.7rem;">
                                        Hết hạn: @voucher.EndDate.ToString("dd/MM/yyyy")
                                    </div>
                                </div>

                                <div class="col-md-2 text-end">
                                    <div class="btn-group shadow-sm rounded-3">
                                        <a asp-action="Details" asp-route-id="@voucher.VoucherId" class="btn btn-white btn-sm px-3 border-end" title="Chi tiết">
                                            <i class="bi bi-eye text-primary"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@voucher.VoucherId" class="btn btn-white btn-sm px-3 border-end" title="Sửa">
                                            <i class="bi bi-pencil text-warning"></i>
                                        </a>
                                        <button onclick="confirmDelete(@voucher.VoucherId)" class="btn btn-white btn-sm px-3 text-danger" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <p class="text-muted">Không tìm thấy mã giảm giá nào phù hợp.</p>
                </div>
            }
        </div>
    </div>
</div>

@* --- Modal Create (Giữ nguyên logic của bạn nhưng tối ưu hóa ID) --- *@
<div class="modal fade" id="createVoucherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white border-0 py-3 px-4 rounded-top-4">
                <h5 class="modal-title fw-bold mb-0">Thiết Lập Voucher Mới</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Create" method="post">
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Mã Voucher</label>
                            <input name="VoucherCode" class="form-control border-0 bg-light rounded-3 text-uppercase fw-bold" placeholder="KM50K" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Loại Giảm Giá</label>
                            <select name="DiscountType" id="mDiscountType" class="form-select border-0 bg-light rounded-3">
                                <option value="Percentage">Phần Trăm (%)</option>
                                <option value="FixedAmount">Cố định (đ)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small">Tên Chương Trình</label>
                            <input name="VoucherName" class="form-control border-0 bg-light rounded-3" placeholder="Chào mừng thành viên mới" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small" id="mLabelValue">Giá trị giảm (%)</label>
                            <div class="input-group">
                                <input name="DiscountValue" type="number" class="form-control border-0 bg-light rounded-start-3" required />
                                <span class="input-group-text border-0 bg-light rounded-end-3" id="mAddon">%</span>
                            </div>
                        </div>
                        <div class="col-md-6" id="mMaxDiscountBox">
                            <label class="form-label fw-bold small">Giảm tối đa (đ)</label>
                            <input name="MaxDiscount" type="number" class="form-control border-0 bg-light rounded-3" placeholder="Không giới hạn" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Đơn tối thiểu (đ)</label>
                            <input name="MinOrderAmount" type="number" class="form-control border-0 bg-light rounded-3" value="0" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Giới hạn sử dụng</label>
                            <input name="UsageLimit" type="number" class="form-control border-0 bg-light rounded-3" placeholder="∞" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Ngày bắt đầu</label>
                            <input name="StartDate" type="datetime-local" class="form-control border-0 bg-light rounded-3" value="@currentTime.ToString("yyyy-MM-ddTHH:mm")" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Ngày kết thúc</label>
                            <input name="EndDate" type="datetime-local" class="form-control border-0 bg-light rounded-3" value="@currentTime.AddMonths(1).ToString("yyyy-MM-ddTHH:mm")" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light rounded-3 px-4" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-dark rounded-3 px-4 fw-bold">Tạo Voucher</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.getElementById('mDiscountType').addEventListener('change', function() {
            const label = document.getElementById('mLabelValue');
            const addon = document.getElementById('mAddon');
            const maxBox = document.getElementById('mMaxDiscountBox');

            if (this.value === 'Percentage') {
                label.textContent = "Giá trị giảm (%)";
                addon.textContent = "%";
                maxBox.style.opacity = "1";
                maxBox.querySelector('input').disabled = false;
            } else {
                label.textContent = "Giá trị giảm (đ)";
                addon.textContent = "đ";
                maxBox.style.opacity = "0.5";
                maxBox.querySelector('input').disabled = true;
            }
        });

        function confirmDelete(id) {
            Swal.fire({
                title: 'Xác nhận xóa?',
                text: "Dữ liệu này sẽ không thể khôi phục!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa ngay',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/AdminVoucher/Delete/' + id,
                        type: 'POST',
                        success: function(res) {
                            if(res.success) {
                                Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi!', res.message, 'error');
                            }
                        }
                    });
                }
            })
        }
    </script>
}

<style>
    .bg-soft-primary {
        background-color: #e7f1ff;
    }

    .bg-soft-success {
        background-color: #e6fcf5;
    }

    .bg-soft-info {
        background-color: #e3f7f8;
    }

    .bg-soft-dark {
        background-color: #f8f9fa;
    }

    .bg-soft-danger {
        background-color: #fff5f5;
    }

    .hover-bg-light:hover {
        background-color: #fafafa;
        transition: 0.2s;
    }

    .extra-small {
        font-size: 0.75rem;
    }

    .btn-white {
        background: #fff;
        border: 1px solid #eee;
    }

        .btn-white:hover {
            background: #f8f9fa;
        }
</style>