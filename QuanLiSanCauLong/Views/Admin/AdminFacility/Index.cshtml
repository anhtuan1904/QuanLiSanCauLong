@model IEnumerable<QuanLiSanCauLong.Models.Facility>
@{
    ViewData["Title"] = "Quản lý cơ sở";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<style>
    .facility-card {
        transition: all 0.25s;
        border: 1.5px solid transparent !important;
    }

        .facility-card:hover {
            transform: translateY(-4px);
            border-color: #198754 !important;
            box-shadow: 0 8px 24px rgba(0,0,0,.10) !important;
        }

    .facility-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: .78rem;
        font-weight: 700;
    }

    .badge-active {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-maintenance {
        background: #fff8e1;
        color: #f57f17;
    }

    .modal-content {
        overflow: hidden;
    }
</style>

<div class="container-fluid px-4 py-4" style="background:#f8f9fa; min-height:100vh;">

    <h4 class="fw-bold mb-4">Quản Lý Cơ Sở</h4>

    <!-- Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold">@Model.Count()</div>
                <div class="text-muted small">Tổng Cơ Sở</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold">@Model.Count(x => x.Status == "Active")</div>
                <div class="text-muted small">Đang Hoạt Động</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold">@Model.Count(x => x.Status == "Maintenance")</div>
                <div class="text-muted small">Bảo Trì</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-3 p-3">
                <div class="fs-2 fw-bold">@Model.Sum(x => x.Courts?.Count ?? 0)</div>
                <div class="text-muted small">Tổng Sân</div>
            </div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="card border-0 shadow-sm rounded-3 mb-4 px-4 py-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <div class="fw-bold mb-1">Quản Lý Cơ Sở Sân</div>
                <div class="text-muted small">Quản lý thông tin các cơ sở sân cầu lông</div>
            </div>
            <button class="btn btn-dark px-4 fw-bold rounded-3"
                    onclick="openCreateModal()">
                <i class="bi bi-plus-lg me-1"></i> Thêm Cơ Sở Mới
            </button>
        </div>
        <div class="mt-3">
            <div class="input-group" style="max-width:480px; border:1px solid #e9ecef; border-radius:10px; overflow:hidden;">
                <span class="input-group-text bg-white border-0 text-muted"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control border-0 shadow-none py-2"
                       placeholder="Tìm kiếm cơ sở..." oninput="filterCards()">
            </div>
        </div>
    </div>

    <!-- Facility Cards Grid -->
    <div class="row g-4" id="facilityGrid">
        @foreach (var f in Model)
        {
            var isActive = f.Status == "Active";
            var statusLabel = isActive ? "Hoạt Động" : (f.Status == "Maintenance" ? "Bảo Trì" : f.Status);
            var statusCls = isActive ? "badge-active" : "badge-maintenance";
            var availableCourts = f.Courts?.Count(c => c.Status == "Available") ?? 0;
            var totalCourts = f.Courts?.Count ?? 0;
            <div class="col-md-6 facility-col" data-name="@f.FacilityName.ToLower()">
                <div class="card border-0 shadow-sm rounded-3 h-100 facility-card">
                    <div class="card-body p-4">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <h5 class="fw-bold mb-0">@f.FacilityName</h5>
                            <span class="facility-badge @statusCls">@statusLabel</span>
                        </div>
                        <!-- Rating -->
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <span class="text-muted small"><i class="bi bi-geo-alt-fill text-secondary me-1"></i>@f.Address</span>
                            <span class="ms-auto text-warning fw-bold"><i class="bi bi-star-fill me-1"></i>4.8</span>
                        </div>

                        <!-- Court Stats -->
                        <div class="row g-0 mb-3">
                            <div class="col-6">
                                <div class="text-muted small mb-1">Tổng Số Sân</div>
                                <div class="fw-bold fs-5">@totalCourts sân</div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted small mb-1">Sân Trống</div>
                                <div class="fw-bold fs-5 text-success">@availableCourts sân</div>
                            </div>
                        </div>

                        <!-- Info List -->
                        <div class="info-list small mb-4">
                            <div class="d-flex justify-content-between py-2 border-top">
                                <span class="text-muted">Giá thuê:</span>
                                <span class="fw-bold text-success">
                                    @(f.Courts?.Any() == true
                                                                    ? f.Courts.Min(c => (decimal?)c.HourlyRate)?.ToString("N0")
                                                                    : "---")đ/giờ
                                </span>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-top">
                                <span class="text-muted">Giờ hoạt động:</span>
                                <span class="fw-bold">
                                    <i class="bi bi-clock me-1"></i>
                                    @(f.OpenTime?.ToString(@"hh\:mm") ?? "--") - @(f.CloseTime?.ToString(@"hh\:mm") ?? "--")
                                </span>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-top">
                                <span class="text-muted">Điện thoại:</span>
                                <span class="fw-bold">@f.Phone</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row g-2">
                            <div class="col-4">
                                <button class="btn btn-outline-primary w-100 rounded-3 py-2 fw-semibold btn-sm"
                                        onclick="openDetailsModal(@f.FacilityId)">
                                    <i class="bi bi-eye me-1"></i>Xem
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary w-100 rounded-3 py-2 fw-semibold btn-sm"
                                        onclick="openEditModal(@f.FacilityId)">
                                    <i class="bi bi-pencil-square me-1"></i>Sửa
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-danger w-100 rounded-3 py-2 fw-semibold btn-sm"
                                        onclick="confirmDelete(@f.FacilityId, '@f.FacilityName')">
                                    <i class="bi bi-trash3 me-1"></i>Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- ======================== UNIFIED MODAL ======================== -->
<div class="modal fade" id="modalFacility" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4" id="modalFacilityContent">
            <!-- Content injected dynamically -->
            <div class="p-5 text-center">
                <div class="spinner-border text-dark"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" style="max-width:420px;">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-10 rounded-circle" style="width:72px;height:72px;">
                        <i class="bi bi-exclamation-triangle text-danger fs-2"></i>
                    </div>
                </div>
                <h5 class="fw-bold mb-2">Xác nhận xóa?</h5>
                <p class="text-muted small mb-4">Bạn có chắc muốn xóa cơ sở <strong id="deleteName" class="text-dark"></strong>?<br>Hành động này không thể hoàn tác.</p>
                <div class="d-flex gap-2">
                    <button class="btn btn-light w-100 rounded-3 fw-semibold py-2" data-bs-dismiss="modal">Hủy</button>
                    <form id="deleteForm" method="post" class="w-100">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger w-100 rounded-3 fw-semibold py-2">Xác nhận xóa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
        // --- QUẢN LÝ BIẾN TOÀN CỤC ---
        let facilityModal;

        // Khởi tạo Modal một lần duy nhất khi trang load xong
        document.addEventListener('DOMContentLoaded', function() {
            const modalEl = document.getElementById('modalFacility');
            if (modalEl) {
                facilityModal = new bootstrap.Modal(modalEl);
            }
        });

        function executeScripts(container) {
            const scripts = container.querySelectorAll("script");
            scripts.forEach(oldScript => {
                const newScript = document.createElement("script");
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        async function fetchModalContent(url, hasScripts = false) {
            const content = document.getElementById('modalFacilityContent');

            // 1. Show Loading
            content.innerHTML = `
                <div class="p-5 text-center">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
                </div>`;

            // 2. Hiện Modal trước để người dùng không phải đợi
            facilityModal.show();

            try {
                const response = await fetch(url);
                const html = await response.text();
                content.innerHTML = html;

                if (hasScripts) {
                    // Đợi HTML render xong rồi mới chạy script
                    setTimeout(() => executeScripts(content), 50);
                }
            } catch (err) {
                content.innerHTML = `<div class="p-5 text-center text-danger">Lỗi: Không thể kết nối đến máy chủ!</div>`;
            }
        }

        // --- CÁC HÀM CỤ THỂ ---
        function openCreateModal() {
            fetchModalContent('/AdminFacility/Create', true);
        }

        function openEditModal(id) {
            fetchModalContent('/AdminFacility/Edit/' + id, true);
        }

        function openDetailsModal(id) {
            fetchModalContent('/AdminFacility/Details/' + id, false);
        }

        function confirmDelete(id, name) {
            const deleteModalEl = document.getElementById('deleteModal');
            document.getElementById('deleteName').textContent = name;

            document.getElementById('deleteForm').onsubmit = async function(e) {
                e.preventDefault();
                const token = this.querySelector('[name=__RequestVerificationToken]').value;

                try {
                    const r = await fetch('/AdminFacility/Delete/' + id, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': token,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: '__RequestVerificationToken=' + encodeURIComponent(token)
                    });
                    const res = await r.json();

                    bootstrap.Modal.getInstance(deleteModalEl).hide();
                    if (res.success) location.reload();
                    else alert(res.message);
                } catch (err) {
                    alert("Lỗi khi xóa cơ sở!");
                }
            };
            new bootstrap.Modal(deleteModalEl).show();
        }

        function filterCards() {
            const q = document.getElementById('searchInput').value.toLowerCase().trim();
            document.querySelectorAll('.facility-col').forEach(col => {
                const name = col.dataset.name.toLowerCase();
                col.style.display = name.includes(q) ? '' : 'none';
            });
        }
    </script>
}