@model QuanLiSanCauLong.Models.Facility
@{
    Layout = null;
    var images = ViewBag.FacilityImages as List<QuanLiSanCauLong.Models.FacilityImage>
                 ?? new List<QuanLiSanCauLong.Models.FacilityImage>();

    var primaryImage = images.FirstOrDefault(i => i.IsPrimary)?.ImagePath
                    ?? (images.Any() ? images.First().ImagePath : "/images/default-facility.jpg");

    // Parse tiện ích
    var amenitySet = (Model.Amenities ?? "")
                     .Split(',', StringSplitOptions.RemoveEmptyEntries)
                     .Select(a => a.Trim())
                     .ToHashSet();

    // Dữ liệu tiện ích để render
    var amenityMap = new (string Key, string Label, string Icon, string Color)[]
    {
        ("parking", "Gửi xe",         "bi-p-square-fill", "#2196f3"),
        ("wifi",    "Wifi",            "bi-wifi",          "#4caf50"),
        ("canteen", "Căng tin",        "bi-cup-hot-fill",  "#ff9800"),
        ("shower",  "Nhà tắm",         "bi-droplet-fill",  "#00bcd4"),
        ("rental",  "Thuê vợt / giày", "bi-bag-fill",      "#9c27b0"),
    };
}

<div class="modal-header border-0 px-4 pt-4 pb-0">
    <div>
        <h5 class="fw-bold mb-1">Chi Tiết Cơ Sở</h5>
        <p class="text-muted small mb-0">Thông tin chi tiết về <strong>@Model.FacilityName</strong></p>
    </div>
    <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body px-4 py-3">
    <div class="row g-4">

        <!-- ══ CỘT TRÁI: Ảnh + Trạng thái ══ -->
        <div class="col-md-5">
            <div class="facility-image-section">
                <!-- Ảnh chính -->
                <div class="main-image-container mb-3 rounded-3 overflow-hidden">
                    <img src="@primaryImage" class="w-100 h-100"
                         style="object-fit:cover;" id="mainDisplayImage"
                         alt="@Model.FacilityName" />
                </div>

                <!-- Thumbnail gallery -->
                @if (images.Count > 1)
                {
                    <div class="d-flex gap-2 flex-wrap mb-3">
                        @foreach (var img in images)
                        {
                            <div class="thumb-image-wrap @(img.IsPrimary ? "active" : "")"
                                 onclick="changeMainImage('@img.ImagePath', this)">
                                <img src="@img.ImagePath" alt="Thumbnail" />
                            </div>
                        }
                    </div>
                }

                <!-- Trạng thái -->
                <div class="text-center mb-2">
                    @{
                        var (badgeCls, statusLabel) = Model.Status switch
                        {
                                    "Active" => ("bg-success", "Hoạt Động"),
                                    "Maintenance" => ("bg-warning text-dark", "Bảo Trì"),
                            _ => ("bg-danger", "Ngừng Hoạt Động")
                        };
                    }
                    <span class="badge @badgeCls px-4 py-2 rounded-pill" style="font-size:.85rem;">
                        @statusLabel
                    </span>
                </div>

                <!-- Google Maps link nếu có tọa độ -->
                @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                {
                    <a href="https://www.google.com/maps?q=@Model.Latitude,@Model.Longitude"
                       target="_blank"
                       class="btn btn-outline-danger w-100 rounded-3 btn-sm mt-1">
                        <i class="bi bi-geo-alt-fill me-1"></i>Xem trên Google Maps
                    </a>
                }
            </div>
        </div>

        <!-- ══ CỘT PHẢI: Thông tin ══ -->
        <div class="col-md-7">
            <div class="facility-details">
                <h4 class="fw-bold mb-3">@Model.FacilityName</h4>

                <!-- Thông tin liên hệ -->
                <div class="info-group mb-3 pb-3">
                    <h6 class="fw-bold text-muted small mb-3 text-uppercase ls-1">Thông Tin Liên Hệ</h6>
                    <div class="row g-2">
                        <div class="col-12">
                            <div class="d-flex align-items-start gap-2">
                                <i class="bi bi-geo-alt-fill text-danger mt-1" style="flex-shrink:0"></i>
                                <div>
                                    <div class="fw-semibold">@Model.Address</div>
                                    <div class="text-muted small">@Model.District, @Model.City</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-start gap-2">
                                <i class="bi bi-telephone-fill text-primary mt-1"></i>
                                <div>
                                    <div class="text-muted" style="font-size:.75rem;">Hotline</div>
                                    <div class="fw-semibold">@(Model.Phone ?? "—")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-start gap-2">
                                <i class="bi bi-clock-fill text-warning mt-1"></i>
                                <div>
                                    <div class="text-muted" style="font-size:.75rem;">Giờ hoạt động</div>
                                    <div class="fw-semibold">
                                        @(Model.OpenTime?.ToString(@"hh\:mm") ?? "--")
                                        –
                                        @(Model.CloseTime?.ToString(@"hh\:mm") ?? "--")
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thống kê sân -->
                <div class="info-group mb-3 pb-3">
                    <h6 class="fw-bold text-muted small mb-3 text-uppercase ls-1">Thông Tin Sân</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-box p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-dark">@(Model.Courts?.Count ?? 0)</div>
                                <div class="text-muted small">Tổng số sân</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box p-3 rounded-3 bg-light text-center">
                                <div class="fs-3 fw-bold text-success">
                                    @(Model.Courts?.Count(c => c.Status == "Available") ?? 0)
                                </div>
                                <div class="text-muted small">Sân đang trống</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tiện ích -->
                @if (amenitySet.Any())
                {
                    <div class="info-group mb-3 pb-3">
                        <h6 class="fw-bold text-muted small mb-3 text-uppercase ls-1">
                            <i class="bi bi-stars me-1" style="color:#d4a017"></i>Tiện Ích Đi Kèm
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var am in amenityMap.Where(a => amenitySet.Contains(a.Key)))
                            {
                                <span class="amenity-tag">
                                    <i class="bi @am.Icon" style="color:@am.Color"></i>
                                    @am.Label
                                </span>
                            }
                        </div>
                    </div>
                }

                <!-- Mô tả -->
                @if (!string.IsNullOrWhiteSpace(Model.Description))
                {
                    <div class="info-group mb-3 pb-3">
                        <h6 class="fw-bold text-muted small mb-2 text-uppercase ls-1">Mô Tả</h6>
                        <p class="text-secondary mb-0" style="line-height:1.7;font-size:.88rem;">
                            @Model.Description
                        </p>
                    </div>
                }

                <!-- Ngày tạo -->
                <div class="text-muted small">
                    <i class="bi bi-calendar-check me-1"></i>
                    Ngày tạo: <strong>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Nút hành động -->
    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
        <button type="button" class="btn btn-light px-4 fw-semibold rounded-3"
                data-bs-dismiss="modal">
            Đóng
        </button>
        <button type="button" class="btn btn-dark px-4 fw-semibold rounded-3"
                onclick="openEditFromDetails(@Model.FacilityId)">
            <i class="bi bi-pencil-square me-1"></i>Chỉnh Sửa
        </button>
    </div>
</div>

<style>
    .thumb-image-wrap {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all .2s;
        flex-shrink: 0;
    }

        .thumb-image-wrap:hover,
        .thumb-image-wrap.active {
            border-color: #198754;
            transform: scale(1.05);
        }

        .thumb-image-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .main-image-container {
        height: 260px;
        border: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .stat-box {
        border: 1px solid #e9ecef;
        transition: all .2s;
    }

        .stat-box:hover {
            border-color: #198754;
            background: #f0f9f4 !important;
        }

    .info-group {
        border-bottom: 1px solid #f0f0f0;
    }

        .info-group:last-of-type {
            border-bottom: none;
        }

    .ls-1 {
        letter-spacing: .05em;
    }

    .amenity-tag {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        padding: .35rem .8rem;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: .82rem;
        color: #333;
        font-weight: 500;
    }
</style>

<script>
    function changeMainImage(imagePath, thumbElement) {
        document.getElementById('mainDisplayImage').src = imagePath;
        document.querySelectorAll('.thumb-image-wrap').forEach(el => el.classList.remove('active'));
        thumbElement.classList.add('active');
    }

    function openEditFromDetails(facilityId) {
        const currentModal = bootstrap.Modal.getInstance(document.getElementById('modalFacility'));
        if (currentModal) currentModal.hide();
        setTimeout(() => openEditModal(facilityId), 300);
    }
</script>
