@model QuanLiSanCauLong.Models.Facility
@{
    Layout = null;
}

<div class="modal-header border-0 px-4 pt-4 pb-0">
    <div>
        <h5 class="fw-bold mb-1">Thêm Cơ Sở Sân Mới</h5>
        <p class="text-muted small mb-0">Nhập thông tin cơ sở sân cầu lông mới</p>
    </div>
    <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body px-4 py-3">
    <form id="createFacilityForm" asp-action="Create" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="row g-3">

            <!-- Tên cơ sở + SĐT -->
            <div class="col-md-7">
                <label class="form-label fw-semibold small text-muted">Tên Cơ Sở <span class="text-danger">*</span></label>
                <input asp-for="FacilityName" class="form-control fi" placeholder="Sân cầu lông ABC – Chi nhánh 1" required />
                <span asp-validation-for="FacilityName" class="text-danger small"></span>
            </div>
            <div class="col-md-5">
                <label class="form-label fw-semibold small text-muted">Hotline Đặt Sân <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text fi border-end-0 rounded-start-3"><i class="bi bi-telephone text-muted"></i></span>
                    <input asp-for="Phone" class="form-control fi border-start-0 rounded-end-3" placeholder="0123 456 789" />
                </div>
            </div>

            <!-- Địa chỉ chi tiết -->
            <div class="col-12">
                <label class="form-label fw-semibold small text-muted">Địa Chỉ Chi Tiết <span class="text-danger">*</span></label>
                <input asp-for="Address" class="form-control fi" placeholder="Số nhà, tên đường, phường/xã..." />
            </div>

            <!-- Quận / Thành phố -->
            <div class="col-md-6">
                <label class="form-label fw-semibold small text-muted">Quận / Huyện</label>
                <input asp-for="District" class="form-control fi" placeholder="Quận 1" />
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold small text-muted">Thành Phố</label>
                <input asp-for="City" class="form-control fi" placeholder="TP.HCM" />
            </div>

            <!-- Giờ mở / đóng cửa -->
            <div class="col-md-6">
                <label class="form-label fw-semibold small text-muted">Giờ Mở Cửa</label>
                <input asp-for="OpenTime" type="time" class="form-control fi" value="05:00" />
            </div>
            <div class="col-md-6">
                <label class="form-label fw-semibold small text-muted">Giờ Đóng Cửa</label>
                <input asp-for="CloseTime" type="time" class="form-control fi" value="22:00" />
            </div>

            <!-- Tọa độ Google Maps -->
            <div class="col-12">
                <label class="form-label fw-semibold small text-muted">
                    <i class="bi bi-pin-map me-1 text-danger"></i>Tọa Độ Google Maps
                    <span class="text-muted fw-normal ms-1" style="font-size:.75rem;">(giúp khách hàng tìm đường)</span>
                </label>
                <div class="row g-2">
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text fi border-end-0 rounded-start-3 small text-muted">Lat</span>
                            <input type="number" step="any" name="Latitude" class="form-control fi border-start-0 rounded-end-3"
                                   placeholder="10.7769" />
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text fi border-end-0 rounded-start-3 small text-muted">Lng</span>
                            <input type="number" step="any" name="Longitude" class="form-control fi border-start-0 rounded-end-3"
                                   placeholder="106.7009" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <a href="https://www.google.com/maps" target="_blank"
                           class="btn btn-outline-secondary w-100 rounded-3 fi d-flex align-items-center justify-content-center gap-1"
                           style="height:38px; font-size:.8rem;">
                            <i class="bi bi-map"></i> Maps
                        </a>
                    </div>
                </div>
                <div class="form-text text-muted" style="font-size:.75rem;">
                    <i class="bi bi-info-circle me-1"></i>Mở Google Maps → Nhấp chuột phải vào địa điểm → Copy tọa độ
                </div>
            </div>

            <!-- Tiện ích đi kèm -->
            <div class="col-12">
                <label class="form-label fw-semibold small text-muted d-block mb-2">
                    <i class="bi bi-stars me-1" style="color:#d4a017"></i>Tiện Ích Đi Kèm
                </label>
                <div class="amenities-grid">
                    <label class="amenity-item">
                        <input type="checkbox" name="Amenities" value="parking" class="amenity-check" />
                        <span class="amenity-box">
                            <i class="bi bi-p-square-fill" style="color:#2196f3"></i>
                            <span>Gửi xe</span>
                        </span>
                    </label>
                    <label class="amenity-item">
                        <input type="checkbox" name="Amenities" value="wifi" class="amenity-check" />
                        <span class="amenity-box">
                            <i class="bi bi-wifi" style="color:#4caf50"></i>
                            <span>Wifi</span>
                        </span>
                    </label>
                    <label class="amenity-item">
                        <input type="checkbox" name="Amenities" value="canteen" class="amenity-check" />
                        <span class="amenity-box">
                            <i class="bi bi-cup-hot-fill" style="color:#ff9800"></i>
                            <span>Căng tin</span>
                        </span>
                    </label>
                    <label class="amenity-item">
                        <input type="checkbox" name="Amenities" value="shower" class="amenity-check" />
                        <span class="amenity-box">
                            <i class="bi bi-droplet-fill" style="color:#00bcd4"></i>
                            <span>Nhà tắm</span>
                        </span>
                    </label>
                    <label class="amenity-item">
                        <input type="checkbox" name="Amenities" value="rental" class="amenity-check" />
                        <span class="amenity-box">
                            <i class="bi bi-bag-fill" style="color:#9c27b0"></i>
                            <span>Thuê vợt / giày</span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Mô tả -->
            <div class="col-12">
                <label class="form-label fw-semibold small text-muted">Mô Tả</label>
                <textarea asp-for="Description" class="form-control fi" rows="2"
                          placeholder="Mô tả ngắn về cơ sở (vị trí thuận tiện, cơ sở vật chất...)"></textarea>
            </div>

            <!-- Hình ảnh cơ sở -->
            <div class="col-12">
                <label class="form-label fw-semibold small text-muted">Hình Ảnh Cơ Sở</label>
                <div class="image-upload-area rounded-3 border border-dashed p-3">
                    <div class="d-flex flex-wrap gap-2 mb-3" id="imagePreviewCreate">
                        <div class="add-img-btn" onclick="document.getElementById('imgInputCreate').click()">
                            <i class="bi bi-plus-lg fs-4 text-muted"></i>
                            <div class="small text-muted mt-1">Thêm ảnh</div>
                        </div>
                    </div>

                    <input type="file" id="imgInputCreate" name="FacilityImages" multiple accept="image/jpeg,image/png,image/webp" style="display:none" />
                    <input type="hidden" name="PrimaryImageIndex" id="mainImageIdxCreate" value="0" />

                    <p class="text-muted mb-0" style="font-size:.8rem;">
                        <i class="bi bi-info-circle me-1"></i>Nhấn vào ảnh để đặt làm ảnh chính. Hỗ trợ JPG, PNG, WEBP.
                    </p>
                </div>
            </div>

        </div>

        <!-- Footer buttons -->
        <div class="d-flex justify-content-end gap-2 mt-4 pt-2 border-top">
            <button type="button" class="btn btn-light px-4 fw-semibold rounded-3" data-bs-dismiss="modal">Hủy</button>
            <button type="submit" class="btn btn-dark px-5 fw-semibold rounded-3">
                <i class="bi bi-plus-circle me-1"></i>Thêm Cơ Sở
            </button>
        </div>
    </form>
</div>

<style>
    .fi {
        background: #f8f9fa !important;
        border: 1px solid #e9ecef !important;
        border-radius: 8px !important;
    }

        .fi:focus {
            background: #fff !important;
            border-color: #212529 !important;
            box-shadow: none !important;
        }

    .border-dashed {
        border-style: dashed !important;
        background: #fafafa;
    }

    /* Amenities grid */
    .amenities-grid {
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
    }

    .amenity-item {
        cursor: pointer;
        margin: 0;
    }

        .amenity-item input.amenity-check {
            display: none;
        }

    .amenity-box {
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: .45rem .9rem;
        border: 1.5px solid #e0e0e0;
        border-radius: 8px;
        background: #fff;
        font-size: .85rem;
        color: #495057;
        transition: all .2s;
        user-select: none;
    }

    .amenity-item input:checked + .amenity-box {
        border-color: #212529;
        background: #f0f0f0;
        color: #212529;
        font-weight: 600;
    }

    .amenity-box i {
        font-size: 1rem;
    }

    .add-img-btn {
        width: 90px;
        height: 90px;
        border: 2px dashed #ced4da;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: .2s;
    }

        .add-img-btn:hover {
            border-color: #212529;
            background: #f5f5f5;
        }

    .img-thumb-wrap {
        position: relative;
        width: 90px;
        height: 90px;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s;
    }

        .img-thumb-wrap:hover {
            border-color: #198754;
        }

        .img-thumb-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img-thumb-wrap .main-star {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(255,193,7,.9);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: .75rem;
        }

        .img-thumb-wrap.is-main {
            border-color: #198754 !important;
            border-width: 3px !important;
        }

            .img-thumb-wrap.is-main .main-star {
                display: flex;
            }

        .img-thumb-wrap .del-btn {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(220,53,69,.9);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: .75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

            .img-thumb-wrap .del-btn:hover {
                background: rgba(220,53,69,1);
                transform: scale(1.1);
            }
</style>

<script>
    (function() {
        const input = document.getElementById('imgInputCreate');
        const previewContainer = document.getElementById('imagePreviewCreate');
        const mainIdxInput = document.getElementById('mainImageIdxCreate');
        const form = document.getElementById('createFacilityForm');
        const addBtn = previewContainer.querySelector('.add-img-btn');

        let selectedFiles = [];

        input.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);

            files.forEach((file) => {
                if (file && file.type.startsWith('image/')) {
                    const uniqueId = Date.now() + Math.random();
                    selectedFiles.push({ id: uniqueId, file: file });

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const wrap = createImageThumb(event.target.result, uniqueId);
                        previewContainer.insertBefore(wrap, addBtn);

                        const activeThumbs = previewContainer.querySelectorAll('.img-thumb-wrap');
                        if (activeThumbs.length === 1) setMainImage(wrap);
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.value = "";
            updateFileInput();
        });

        function createImageThumb(src, id) {
            const wrap = document.createElement('div');
            wrap.className = 'img-thumb-wrap';
            wrap.dataset.uid = id;
            wrap.innerHTML = `
                <img src="${src}" alt="Preview" />
                <div class="main-star"><i class="bi bi-star-fill"></i></div>
                <button type="button" class="del-btn" title="Xóa ảnh"><i class="bi bi-x"></i></button>
            `;
            wrap.addEventListener('click', function(e) {
                if (!e.target.closest('.del-btn')) setMainImage(wrap);
            });
            wrap.querySelector('.del-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                removeImage(wrap, id);
            });
            return wrap;
        }

        function setMainImage(wrap) {
            previewContainer.querySelectorAll('.img-thumb-wrap').forEach(w => w.classList.remove('is-main'));
            wrap.classList.add('is-main');
            updateFileInput();
        }

        function removeImage(wrap, id) {
            const wasMain = wrap.classList.contains('is-main');
            selectedFiles = selectedFiles.filter(item => item.id !== id);
            wrap.remove();
            if (wasMain) {
                const nextImg = previewContainer.querySelector('.img-thumb-wrap');
                if (nextImg) setMainImage(nextImg);
            }
            updateFileInput();
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            let serverIndex = 0;
            let finalMainIdx = 0;

            const thumbs = previewContainer.querySelectorAll('.img-thumb-wrap');
            thumbs.forEach((thumb) => {
                const uid = parseFloat(thumb.dataset.uid);
                const fileItem = selectedFiles.find(item => item.id === uid);
                if (fileItem) {
                    dataTransfer.items.add(fileItem.file);
                    if (thumb.classList.contains('is-main')) finalMainIdx = serverIndex;
                    serverIndex++;
                }
            });

            input.files = dataTransfer.files;
            if (mainIdxInput) mainIdxInput.value = finalMainIdx;
        }

        // AJAX SUBMIT
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                const formData = new FormData(this);

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';

                    const response = await fetch(this.action, { method: 'POST', body: formData });

                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("Lỗi Server (Không trả về JSON)");
                    }

                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        alert("Lỗi: " + result.message);
                    }
                } catch (error) {
                    alert("Lỗi hệ thống: " + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });
        }
    })();
</script>
