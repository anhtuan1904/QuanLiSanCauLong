@model QuanLiSanCauLong.Models.PriceSlot
@{
    ViewData["Title"] = "Tạo giá hàng loạt";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-success"><i class="bi bi-lightning-charge-fill"></i> Tạo giá hàng loạt</h3>
            <p class="text-muted small">Thiết lập nhanh khung giờ cho nhiều sân cùng lúc</p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary border-0"><i class="bi bi-arrow-left me-2"></i>Quay lại</a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form id="bulkForm">
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h5 class="mb-0 fw-bold"><span class="badge bg-success me-2">1</span> Đối tượng áp dụng</h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Chọn Cơ sở</label>
                            <select id="facilitySelect" class="form-select shadow-none" required>
                                <option value="">-- Chọn cơ sở --</option>
                                @foreach (var facility in ViewBag.Facilities)
                                {
                                    <option value="@facility.FacilityId">@facility.FacilityName</option>
                                }
                            </select>
                        </div>
                        <div class="mb-2 fw-semibold small text-muted text-uppercase">Danh sách sân</div>
                        <div id="courtList" class="p-3 bg-light rounded-3 border" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted mb-0 small text-center py-3">Vui lòng chọn cơ sở để hiển thị danh sách sân</p>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px;">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h5 class="mb-0 fw-bold"><span class="badge bg-success me-2">2</span> Thiết lập khung giờ & Giá</h5>
                    </div>
                    <div class="card-body pt-0">
                        <div class="row g-2 p-3 bg-light rounded-3 border mb-3">
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Bắt đầu</label>
                                <input type="time" class="form-control shadow-none" id="newStartTime" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Kết thúc</label>
                                <input type="time" class="form-control shadow-none" id="newEndTime" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold">Giá (₫)</label>
                                <input type="number" class="form-control shadow-none" id="newPrice" placeholder="100,000" />
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-success w-100 fw-bold" onclick="addTimeSlot()">
                                    <i class="bi bi-plus-lg me-1"></i> Thêm
                                </button>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="newIsPeakHour">
                                    <label class="form-check-label small" for="newIsPeakHour">Đánh dấu là Giờ cao điểm</label>
                                </div>
                            </div>
                        </div>

                        <div id="timeSlotsList">
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px; border-radius: 15px;">
                <div class="card-header bg-dark text-white py-3 border-bottom-0" style="border-radius: 15px 15px 0 0;">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-eye me-2"></i>Tổng quan cấu hình</h6>
                </div>
                <div class="card-body">
                    <div id="previewContent">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-clipboard2-plus fs-1 opacity-25"></i>
                            <p class="small mt-2">Chưa có dữ liệu thiết lập</p>
                        </div>
                    </div>
                    <hr>
                    <button type="button" class="btn btn-primary w-100 py-2 fw-bold shadow-sm" onclick="submitBulkCreate()">
                        <i class="bi bi-cloud-upload me-2"></i> XÁC NHẬN TẠO NGAY
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let timeSlots = [];

        // Load sân bằng AJAX
        $('#facilitySelect').change(function() {
            const fId = $(this).val();
            if (!fId) return;

            $.getJSON(`/AdminPriceSlot/GetCourtsByFacility`, { facilityId: fId }, function(data) {
                let html = '';
                data.forEach(court => {
                    html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input court-checkbox" type="checkbox" value="${court.courtId}" id="c${court.courtId}" onchange="updatePreview()">
                            <label class="form-check-label small fw-semibold" for="c${court.courtId}">
                                Sân ${court.courtNumber} <span class="text-muted">(${court.courtType})</span>
                            </label>
                        </div>`;
                });
                $('#courtList').html(html);
                updatePreview();
            });
        });

        function addTimeSlot() {
            const start = $('#newStartTime').val();
            const end = $('#newEndTime').val();
            const price = $('#newPrice').val();
            const isPeak = $('#newIsPeakHour').is(':checked');

            if(!start || !end || !price) {
                alert("Vui lòng nhập đầy đủ thông tin khung giờ!");
                return;
            }

            timeSlots.push({ startTime: start, endTime: end, price: price, isPeakHour: isPeak });
            renderTimeSlots();
            updatePreview();
        }

        function renderTimeSlots() {
            let html = '';
            timeSlots.forEach((slot, index) => {
                html += `
                <div class="d-flex align-items-center justify-content-between p-2 mb-2 bg-white border rounded shadow-sm">
                    <div class="small">
                        <span class="fw-bold text-primary">${slot.startTime} - ${slot.endTime}</span>
                        <span class="mx-2">|</span>
                        <span class="fw-bold text-success">${parseInt(slot.price).toLocaleString()}₫</span>
                        ${slot.isPeakHour ? '<span class="badge bg-danger ms-2">Peak</span>' : ''}
                    </div>
                    <button class="btn btn-link text-danger p-0" onclick="removeSlot(${index})"><i class="bi bi-trash"></i></button>
                </div>`;
            });
            $('#timeSlotsList').html(html);
        }

        function removeSlot(index) {
            timeSlots.splice(index, 1);
            renderTimeSlots();
            updatePreview();
        }

        function updatePreview() {
            const selectedCourts = $('.court-checkbox:checked').length;
            const totalSlots = selectedCourts * timeSlots.length;

            if (totalSlots > 0) {
                $('#previewContent').html(`
                    <div class="alert alert-primary border-0 small mb-0">
                        Hệ thống sẽ khởi tạo <strong>${totalSlots}</strong> bản ghi đơn giá vào cơ sở dữ liệu.
                    </div>
                    <ul class="list-group list-group-flush small mt-3">
                        <li class="list-group-item d-flex justify-content-between">Số lượng sân: <span>${selectedCourts}</span></li>
                        <li class="list-group-item d-flex justify-content-between">Số khung giờ: <span>${timeSlots.length}</span></li>
                    </ul>
                `);
            } else {
                $('#previewContent').html('<p class="text-center text-muted small py-3">Chọn ít nhất 1 sân và 1 khung giờ</p>');
            }
        }

        function submitBulkCreate() {
            const courtIds = $('.court-checkbox:checked').map(function() { return $(this).val(); }).get();
            if (courtIds.length === 0 || timeSlots.length === 0) {
                alert("Vui lòng chọn đủ Sân và Khung giờ!");
                return;
            }

            const payload = { courtIds: courtIds, timeSlots: timeSlots };

            $.ajax({
                url: '/Admin/PriceSlot/BulkCreate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(res) {
                    if(res.success) {
                        alert("Đã tạo thành công!");
                        window.location.href = '/Admin/PriceSlot';
                    }
                }
            });
        }
    </script>
}